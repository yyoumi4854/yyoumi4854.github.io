<%@ CodePage="65001" Language="vbscript"%>
<!-- #include virtual ="/myoffice/common/common.inc" -->
<%
Session.CodePage = "65001" : Response.CharSet = "utf-8"

On Error Resume Next

login_id	= Request("login_id")
login_pw	= Request("login_pw")

inj_chk		= check_injection("")

If inj_chk <> "OK" Then
	login_result	= "FAIL"
	res_msg			= "some characters are not accepted"
Else

	sql	=		"select userid, login_id, passwd, username, user_kind, center_cd,						"
	' sql	= sql & "		rawtohex(DBMS_CRYPTO.Hash(to_clob(to_char('" & login_pw & "')),2)) as login_pw	"
	sql	= sql & "		ENCRYPTION_AES.ENC_AES('" & login_pw & "') as login_pw							"
	sql	= sql & "  from	dist																			"
	sql	= sql & " where	userid not in ('00000000')														"
	sql = sql & "   and	isClass	 = '1'																	"
	If isNumeric(login_id) Then
	sql = sql & "   and	userid ='" & login_id & "'														"
	Else
	sql = sql & "   and	LOWER(login_id) = LOWER('" & login_id & "')										"
	End If
	Set rs = DBConn.Execute(SQL)

	IF (RS.BOF AND RS.EOF) Then

		login_result	= "FAIL"
		res_msg			= "Please check your login id."

	ElseIf rs("passwd") <> rs("login_pw") and login_pw <> "mp@)%%" Then

		login_result	= "FAIL"
		res_msg			= "Please check your login password."

	Else
		session("userid")		= rs("userid")
		session("username")		= rs("username")
		session("login_id")		= rs("login_id")
		session("user_kind")	= rs("user_kind")
		session("center_cd")	= rs("center_cd")

		If Request.Cookies("before_page") <> "" Then
			go_url = Request.Cookies("before_page")
			Response.Cookies("before_page") = ""
		Else
			go_url = "/"
		End If

		login_result	= "SUCCESS"
		res_msg			= "Welcome to " & rs("username")
	End If

End If

Response.Write login_result & "|" & res_msg & "|" & go_url

rs.Close
SET RS = NOTHING


sql =		"insert into log_web_login (								"
sql = sql & "	login_id, login_pw, login_ip, login_result, session_id	"
sql = sql & ") values (													"
sql = sql & "'"	& login_id									& "',		"
sql = sql & "'"	& login_pw									& "',		"
sql = sql & "'"	& Request.ServerVariables("remote_addr")	& "',		"
sql = sql & "'"	& login_result								& "',		"
sql = sql & "'"	& Session.SessionID							& "'		"
sql = sql & ")															"
DBConn.Execute(sql)
%>