<%@ CodePage="65001" Language="vbscript"%>
<!-- #include virtual = "/myoffice/common/common.inc" -->

<!-- #include virtual = "/myoffice/inc/head.html" -->

<!-- #include virtual = "/myoffice/inc/header.html" -->

<!-- #include virtual = "/myoffice/inc/nav.html" -->
<% Call Check_Login(fURL) %>
<style>
	.num_right {text-align:right !important;}
</style>
<div id="container">
	<div class="contentHeader">
		<h3 class="contentTitle"><i class="fa fa-th-large" aria-hidden="true"></i> Order History</h3>
	</div>
	<div class="content">
		<div class="section">
			<h3 class="sectionTitle">Report period</h3>
			<div class="innerBox">
				<form>
					<div class="searchBox">
						<div class="searchInner">
							<input type="text" name="st_date" id="st_date" class="inputFromDate" value="<%=date%>">
							<input type="text" name="ed_date" id="ed_date" class="inputToDate" value="<%=date%>">
							<button type="button" class="btnSearch" id="btnSearch"><i class="fa fa-search" aria-hidden="true"></i> INQUIRY</button>
						</div>
					</div>
				</form>
			</div>
		</div>
		<div class="section">
			<div class="innerBox" style="padding:10px;">
				<table id="dataTable" class="display nowrap" style="width:100%">
					<thead>
						<tr>
							<th>Category</th>
							<th>Order Number</th>
							<th>Order Date</th>
							<th>Order amount</th>
							<th>Payment Method</th>
							<th>USD</th>
							<th>BANK</th>
							<th>GTXp</th>
							<th>Transaction ID number</th>
							<th>Status</th>
						</tr>
					</thead>
				</table>
			</div>
		</div>
	</div>
</div>

<!-- #include virtual = "/myoffice/inc/footer.html" -->

<div id="purchasePopup" style="display:none">
	<h1 class="purchasePopupTitle">Trasaction ID number</h1>
	<div class="purchasePopupContent">
		<div class="addressContentBox">
			<dl class="addressContentInner">
				<dt class="bankAccount"><span id="coin_title">ETH</span></dt>
				<dd class="bankAddr"><span style="color:red;">To complete your order, please enter the Coin deposit trasaction ID number for your order.</span></dd>
				<dd class="bankAddr">
					<div class="tableBox">
						<label for="tran_no">
							<div class="labelInnerBox" style="text-align:left;">
								<span class="inputTitle">Coin deposit trasaction ID number</span>
							</div>
						</label>
						<input type="text" name="tran_no" id="tran_no" placeholder="Enter Trasaction ID number"
							   check="T" check_type="length" check_length="0" check_key=""
							   title="Please enter the transaction ID."
							   maxLength="30" value="<%=p_id%>">
						<span class="focus-input100"></span>
						<input	type="hidden" name="order_no" id="order_no" value="" />
					</div>
				</dd>
			</dl>
		</div>
		<div class="addressContentBox">
			<div class="btnPopupBox">
				<a href="javascript:void(0);" id="btnSend" class="btnPopupOkay">OK</a>
				<a href="#purchasePopup" rel="modal:close" class="btnPopupCancel">Cancel</a>
			</div>
		</div>
	</div>
</div>

<div id="popOrderDetail" style="display:none">
	<h1 class="orderDetailTitle">Order information</h1>
	<div id="reportContent">
		<div class="orderDetailBox">
			<h3 class="orderDetailInnerTitle">Payment information</h3>
			<div class="orderDetailOuter">
				<div class="orderDetailInner">
					<div class="orderDetailDataBox">
						<strong class="orderDetailDataName">Payment method</strong>
						<span class="orderDetailData"></span>
					</div>
					<div class="orderDetailDataBox">
						<strong class="orderDetailDataName">Status</strong>
						<span class="orderDetailData"></span>
					</div>
					<div class="orderDetailDataBox">
						<strong class="orderDetailDataName">Payment amounts</strong>
						<span class="orderDetailData"></span>
					</div>
					<div class="orderDetailDataBox">
						<strong class="orderDetailDataName">Payment date</strong>
						<span class="orderDetailData"></span>
					</div>
				</div>
			</div>
		</div>
		<div>
			<h3 class="orderDetailInnerTitle">Order details</h3>
			<div class="orderDetailOuter">

				<div class="orderDetailInner">
					<div class="orderDetailDataBox">
						<strong class="orderDetailDataName">Order number</strong>
						<span class="orderDetailData"></span>
					</div>
					<div class="orderDetailDataBox">
						<strong class="orderDetailDataName">Product name</strong>
						<span class="orderDetailData"></span>
					</div>
					<div class="orderDetailDataBox">
						<strong class="orderDetailDataName">Quantity</strong>
						<span class="orderDetailData"></span>
					</div>
					<div class="orderDetailDataBox">
						<strong class="orderDetailDataName">Unit price</strong>
						<span class="orderDetailData"></span>
					</div>
					<div class="orderDetailDataBox">
						<strong class="orderDetailDataName">Total price</strong>
						<span class="orderDetailData"></span>
					</div>
				</div>

				<div class="orderDetailInner">
					<div class="orderDetailDataBox">
						<strong class="orderDetailDataName">Order number</strong>
						<span class="orderDetailData"></span>
					</div>
					<div class="orderDetailDataBox">
						<strong class="orderDetailDataName">Product name</strong>
						<span class="orderDetailData"></span>
					</div>
					<div class="orderDetailDataBox">
						<strong class="orderDetailDataName">Quantity</strong>
						<span class="orderDetailData"></span>
					</div>
					<div class="orderDetailDataBox">
						<strong class="orderDetailDataName">Unit price</strong>
						<span class="orderDetailData"></span>
					</div>
					<div class="orderDetailDataBox">
						<strong class="orderDetailDataName">Total price</strong>
						<span class="orderDetailData"></span>
					</div>
				</div>

			</div>
		</div>
	</div>
	<div class="addressContentBox qr cBTC" style="display:none;">
		<dl class="addressContentInner">
			<dt class="bankAccount">BTC</dt>
			<dd class="addressNotice">To deposit the payment for your order, please copy the address below or Scan the QR code to get the deposit address.</dd>
			<dd class="bankAddr">
				<div>
					<span class="bankAddrText">1MXpoT9cgG7r41GDNhnVAPc6WdQgndFuHY</span>
					<button type="button" class="btnBankAddrCopy" data-clipboard-action="copy" data-clipboard-text="1MXpoT9cgG7r41GDNhnVAPc6WdQgndFuHY">Copy</button>
				</div>
			</dd>
			<dd class="bankQRCode">
				<img src="/myoffice/img/common/btc_qr_code.png" alt="BTC QR Code">
			</dd>
		</dl>
	</div>
	<div class="addressContentBox qr cETH">
		<dl class="addressContentInner">
			<dt class="bankAccount">ETH</dt>
			<dd class="addressNotice">To deposit the payment for your order, please copy the address below or Scan the QR code to get the deposit address.</dd>
			<dd class="bankAddr">
				<div>
					<span class="bankAddrText">0x263be76183bb26c507156adf57e2bc6d19482428</span>
					<button type="button" class="btnBankAddrCopy" data-clipboard-action="copy" data-clipboard-text="0x263be76183bb26c507156adf57e2bc6d19482428">Copy</button>
				</div>
			</dd>
			<dd class="bankQRCode">
				<img src="/myoffice/img/common/eth_qr_code.png" alt="ETH QR Code">
			</dd>
		</dl>
	</div>
	<div class="addressContentBox">
		<div class="btnPopupBox">
			<a href="javascript:void(0);" id="btnDetailOk" class="btnPopupOkay">OK</a>
			<a href="javascript:void(0);" rel="modal:close" class="btnPopupCancel">Cancel</a>
		</div>
	</div>
</div>

<script type="text/javascript">
	$(function(){
		$("#st_date").datepicker({
			dateFormat: "yy-mm-dd"
		});
		$("#ed_date").datepicker({
			dateFormat: "yy-mm-dd"
		});

		var $tblOrder = $("#dataTable").DataTable({
				scrollX : true,
				searching : false,
				lengthChange : false,
				ajax: {
					url: "/myoffice/json_data/my_order_json.html",
					dataSrc: "list",
					type: "POST",
					data : function (d){
						d.st_date		= $("#st_date").val();
						d.ed_date		= $("#ed_date").val();
						d.userid		= "<%=Session("userid")%>";
					}
				},
				columns: [
					{ data: "order_type" },
					{ data: "order_no" },
					{ data: "order_date" },
					{ data: "tot_amt" },
					{ data: "pay_kind" },
					{ data: "usd_amt" },
					{ data: "bank_amt" },
					{ data: "point_amt" },
					{ data: "tran_no" },
					{ data: "order_state" }
				],
				columnDefs: [
					{
						targets : [3, 5, 6],
						className : "num_right",
						render : function(data, type, row){
							var rtnData = numeral(data).format("$0,0.00");
							return rtnData;
						}
					},
					{
						targets : [7],
						className : "num_right",
						render : function(data, type, row){
							var rtnData = numeral(data).format("0,0");
							return rtnData;
						}
					},
					{
						targets : [8],
						render : function(data, type, row, meta){
							var rtnData = data;
							if (data == "-") {
								rtnData = "<label style=\"color:red\">Click here</label>"
							}
							return rtnData;
						}
					}
				],
				order: [[1, "desc"]],
				pagingType : "numbers"
			});

		$("#btnSearch").on("click", function(){
			$tblOrder.ajax.reload();
		});

		//$('#dataTable tbody').on('dblclick', 'td', function () {
		$('#dataTable tbody').on('click', 'td', function () {
			var tr = $(this).closest('tr');
			var row = $tblOrder.row( tr );
			var intCell = $tblOrder.cell(this)[0][0].column;
			var valueCell = $tblOrder.cell(this).data();
//			console.log($tblOrder.cell( this )[0][0].column);
//			console.log(row.data());
			if (intCell == 8 && valueCell == '-'){
				popTranInput(row.data());
				return;
			}
			if (intCell == 1){
				order_detail(valueCell);
				return;
			}
		} );
	});

	function popTranInput(n){
		var $coin_title = $("#coin_title");
		var $order_no = $("#order_no");
		var $tran_no = $("#tran_no");
		if (n.tran_no != '-'){
			return false;
		} else {
			$coin_title.text(n.pay_kind);
			$order_no.val(n.order_no);
			$tran_no.val("");
			$("#purchasePopup").modal();
		}
	}

	$("#btnSend").on("click", function(){
		regTran_no();
	});

	$("#btnDetailOk").on("click", function(){
		var obj = eval({"order_no":$(this).attr("order-no"),
						"pay_kind":$(this).attr("pay-kind"),
						"tran_no":"-"});
		popTranInput(obj);
	});

	function regTran_no(){
		var $order_no = $("#order_no");
		var $tran_no = $("#tran_no");
		var $btnPopupCancel = $(".btnPopupCancel");
		if(!$order_no.val()){
			alert("Incorrect data was inputted, Please try it again.");
			$btnPopupCancel.trigger("click");
			return false;
		}
		if(!$tran_no.val()){
			alert($tran_no.attr("title"));
			$tran_no.focus();
			return false;
		}

		var url = "/myoffice/common/reg_tran_no_proc.html";
		var data = {
					"order_no": $order_no.val(),
					"tran_no" : $tran_no.val()
					};

		$.ajax({
			url : url,
			global :false,
			contentType : "application/x-www-form-urlencoded; charset=euc-kr",
			type : "POST",
			data : data,
			dataType: 'text',
			crossDomain: true,
			async:false,
			success:function(rtnData){
				var arrItem = rtnData.split("|");
				var rtnState= arrItem[0];
				var rtnMsg 	= arrItem[1].replace(/\\n/g, '\n');

				if (rtnState == "SUCCESS") {
					alert(rtnMsg);
					$btnPopupCancel.trigger("click");
					$("#btnSearch").trigger("click");
				} else {
					alert(rtnMsg);
				}
			},
			error:function(reponse,textStatus,errorThrown){
				alert("Sorry!!! Some errors are occurred.\n\nPlease try again later.\n\nThank you.");
			},
			beforeSend:function(){
			}
		});
	}

	function order_detail(order_no){
		if (!order_no)
		{
			alert("데이터가 정확하지 않습니다.");
			return false;
		}
		$("#reportContent").html("");
		order_pay_json(order_no);
		order_detail_json(order_no);
		$("#popOrderDetail").modal("show");
		$("#btnDetailOk").hide();
	}

	function order_detail_json(order_no){
		if (!order_no)
		{
			alert("데이터가 정확하지 않습니다.");
			return false;
		}

		var url = "/myoffice/json_data/my_order_detail_json.html";
		var data = {
				order_no : order_no
			};
		$.post(url, data, function(jsonData) {
			setOrderDetail(jsonData.list);
		}, 'json')
		.fail(function (jqXHR, textStatus, errorThrown) {
			alert('HTTP status code: ' + jqXHR.status + '\n' +
				'textStatus: ' + textStatus + '\n' +
				'errorThrown: ' + errorThrown);
			alert('HTTP message body (jqXHR.responseText): ' + '\n' + jqXHR.responseText);
		});
	}

	function setOrderDetail(jsonData){
		var addHtml = "";

			addHtml += "<div>";
			addHtml += "	<h3 class=\"orderDetailInnerTitle\">Order details</h3>";
			addHtml += "	<div class=\"orderDetailOuter\">";
		$.each(jsonData, function(key, items){
			addHtml += "		<div class=\"orderDetailInner\">";
			addHtml += "			<div class=\"orderDetailDataBox\">";
			addHtml += "				<strong class=\"orderDetailDataName\">Order number</strong>";
			addHtml += "				<span class=\"orderDetailData\">" + items.order_no + "</span>";
			addHtml += "			</div>";
			addHtml += "			<div class=\"orderDetailDataBox\">";
			addHtml += "				<strong class=\"orderDetailDataName\">Product name</strong>";
			addHtml += "				<span class=\"orderDetailData\">" + items.product_name + "</span>";
			addHtml += "			</div>";
			addHtml += "			<div class=\"orderDetailDataBox\">";
			addHtml += "				<strong class=\"orderDetailDataName\">Quantity</strong>";
			addHtml += "				<span class=\"orderDetailData\">" + numeral(items.qty).format('0,0') + "</span>";
			addHtml += "			</div>";
			addHtml += "			<div class=\"orderDetailDataBox\">";
			addHtml += "				<strong class=\"orderDetailDataName\">Unit price</strong>";
			addHtml += "				<span class=\"orderDetailData\">" + numeral(items.amt).format('$0,0.00') + "</span>";
			addHtml += "			</div>";
			addHtml += "			<div class=\"orderDetailDataBox\">";
			addHtml += "				<strong class=\"orderDetailDataName\">Total price</strong>";
			addHtml += "				<span class=\"orderDetailData\">" + numeral(items.order_amt).format('$0,0.00') + "</span>";
			addHtml += "			</div>";
			addHtml += "		</div>";
		});
			addHtml += "	</div>";
			addHtml += "</div>";
		$("#reportContent").append(addHtml);
	}

	function order_pay_json(order_no){
		if (!order_no)
		{
			alert("데이터가 정확하지 않습니다.");
			return false;
		}

		var url = "/myoffice/json_data/my_order_pay_json.html";
		var data = {
				order_no : order_no
			};
		$.post(url, data, function(jsonData) {
			setOrderPay(jsonData.list);
		}, 'json')
		.fail(function (jqXHR, textStatus, errorThrown) {
			alert('HTTP status code: ' + jqXHR.status + '\n' +
				'textStatus: ' + textStatus + '\n' +
				'errorThrown: ' + errorThrown);
			alert('HTTP message body (jqXHR.responseText): ' + '\n' + jqXHR.responseText);
		});
	}

	function setOrderPay(jsonData){
		var payHtml = "";
		$(".qr").hide();
		$.each(jsonData, function(key, items){
			payHtml += "<div class=\"orderDetailBox\">";
			payHtml += "	<h3 class=\"orderDetailInnerTitle\">Payment information</h3>";
			payHtml += "	<div class=\"orderDetailOuter\">";
			payHtml += "		<div class=\"orderDetailInner\">";
			payHtml += "			<div class=\"orderDetailDataBox\">";
			payHtml += "				<strong class=\"orderDetailDataName\">Payment method</strong>";
			payHtml += "				<span class=\"orderDetailData\">" + items.pay_name + "</span>";
			payHtml += "			</div>";
			payHtml += "			<div class=\"orderDetailDataBox\">";
			payHtml += "				<strong class=\"orderDetailDataName\">Status</strong>";
			payHtml += "				<span class=\"orderDetailData\">" + items.pay_states + "</span>";
			payHtml += "			</div>";
			payHtml += "			<div class=\"orderDetailDataBox\">";
			payHtml += "				<strong class=\"orderDetailDataName\">Payment amounts</strong>";
			payHtml += "				<span class=\"orderDetailData\">";
			if (items.pay_name == "POINT") {
				payHtml += numeral(items.pay_amt).format('0,0') + " GTXp"
			} else {
				payHtml += numeral(items.pay_amt).format('$0,0.00')
			}
			payHtml += "				</span>";
			payHtml += "			</div>";
			payHtml += "			<div class=\"orderDetailDataBox\">";
			payHtml += "				<strong class=\"orderDetailDataName\">Payment date</strong>";
			payHtml += "				<span class=\"orderDetailData\">" + items.work_date + "</span>";
			payHtml += "			</div>";
			if (items.pay_name == "BANK") {
				payHtml += "		<div class=\"orderDetailDataBox\">";
				payHtml += "			<strong class=\"orderDetailDataName\">Bank account number</strong>";
				payHtml += "			<span class=\"orderDetailData\">" + items.bank_info + "</span>";
				payHtml += "		</div>";
			}
			payHtml += "		</div>";
			payHtml += "	</div>";
			payHtml += "</div>";
			if (items.tran_no == "-"){
				$(".c"+ items.pay_name).show();
				$("#btnDetailOk").show();
				$("#btnDetailOk").attr("order-no", this.order_no);
				$("#btnDetailOk").attr("pay-kind", this.pay_kind);
			}
		});

		$("#reportContent").prepend(payHtml);
	}
</script>