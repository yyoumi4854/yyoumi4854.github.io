<%@ CodePage="65001" Language="vbscript"%>
<!-- #include virtual = "/myoffice/common/common.inc" -->

<!-- #include virtual = "/myoffice/inc/head.html" -->

<!-- #include virtual = "/myoffice/inc/header.html" -->

<!-- #include virtual = "/myoffice/inc/nav.html" -->
<% Call Check_Login("/myoffice") %>
<div id="container">
	<div class="contentHeader">
		<h3 class="contentTitle"><i class="fa fa-th-large" aria-hidden="true"></i> Order</h3>
	</div>
	<div class="content">
		<div class="section">
			<form name="frm_order" id="frm_order">
			<div class="orderBox">
				<%
				sql =		"select	a.username,a.zipcode,a.e_mail, country,														"
				sql = sql & "  ENCRYPTION_AES.DEC_AES(a.mobile) as mobile, ENCRYPTION_AES.DEC_AES(a.address1) as  address1,		"
				sql = sql & "  ENCRYPTION_AES.DEC_AES(a.address2) address2														"
				sql = sql & "  from	dist A																						"
				sql = sql & " where	A.userid = '" & Session("userid") & "'														"
				Set rs_u = DBConn.Execute(sql)

				username	= rs_u("username")
				If InStr(username, ",") > 0 Then
					arryName	= Split(username, ",")
					lastname	= arryName(0)
					firstname	= arryName(1)
				Else
					firstname	= username
				End If

				ord_mobile	= rs_u("mobile")

				country		= rs_u("country")
				zipcode		= rs_u("zipcode")
				addr1		= rs_u("address1")
				addr2		= rs_u("address2")

				ord_email	= rs_u("e_mail")
				email_temp	= fn_normal(ord_email,"@","MAIL")
				email		= Split(email_temp,",")

				rs_u.Close : Set rs_u = Nothing
				%>
				<input  type="hidden" name="userid" id="userid" value="<%=Session("userid")%>" />
				<input  type="hidden" name="user_name" id="user_name" value="<%=username%>" />
				<input	type="hidden" name="user_mobile" id="user_mobile" class="tel" value="<%=ord_mobile%>" />
				<input  type="hidden" name="user_zip"	id="user_zip"	value="<%=zip_code%>"  />
				<input	type="hidden" name="user_addr1" id="user_addr1" value="<%= ADDR1 %>" />
				<input	type="hidden" name="user_addr2" id="user_addr2" value="<%= ADDR2 %>" />
				<input  type="hidden" name="user_email"	value="<%= ord_email %>">
				<div class="orderLeftBox">
					<div class="detailBox">
						<h3 class="productName">Ship to</h3>
						<div class="tableBox">
							<label for="d_country">
								<div class="labelInnerBox">
									<span class="inputTitle">Country</span>
								</div>
							</label>
							<select name="d_country" id="d_country"
									check="T" check_type="length" check_length="0" check_key=""
									title="Please select the country field.">
								<%
								sql =		"select	country, country_name	"
								sql = sql & "  from	country					"
								sql = sql & " where	isUSE = '1'				"
								sql = sql & " order by country				"
								Set rs_country = DBConn.Execute(sql)

								Do While Not rs_country.EOF
									Response.Write "<option value='" & rs_country("country") & "'>" & rs_country("country_name") & "</option>"
									rs_country.MoveNext
								Loop
								rs_country.Close
								%>
							</select>
							<span class="focus-input100"></span>
							<script>$("#d_country").val("<%=country%>");</script>
						</div>
						<div class="tableBox">
							<label for="d_firstname">
								<div class="labelInnerBox">
									<span class="inputTitle">First Name</span>
								</div>
							</label>
							<input type="text" name="d_firstname" id="d_firstname" placeholder="Enter First Name"
								   check="T" check_type="length" check_length="0" check_key=""
								   title="Please fill in the firstname field."
								   value="<%=firstname%>">
							<span class="focus-input100"></span>
						</div>
						<div class="tableBox">
							<label for="d_lastname">
								<div class="labelInnerBox">
									<span class="inputTitle">Last Name</span>
								</div>
							</label>
							<input type="text" name="d_lastname" id="d_lastname" placeholder="Enter Last Name"
								   check="T" check_type="length" check_length="0" check_key=""
								   title="Please fill in the lastname field."
								   value="<%=lastname%>">
							<span class="focus-input100"></span>
						</div>
						<div class="tableBox">
							<label for="d_addr2">
								<div class="labelInnerBox">
									<span class="inputTitle">Street address</span>
								</div>
							</label>
							<input type="text" name="d_addr2" id="d_addr2" placeholder="Enter Street address"
								   check="T" check_type="length" check_length="0" check_key=""
								   title="Please fill in the Street address field."
								   value="<%=addr2%>">
							<span class="focus-input100"></span>
						</div>
						<div class="tableBox">
							<label for="d_addr1">
								<div class="labelInnerBox">
									<span class="inputTitle">City / State</span>
								</div>
							</label>
							<input type="text" name="d_addr1" id="d_addr1" placeholder="Enter City / State"
								   check="T" check_type="length" check_length="0" check_key=""
								   title="Please fill in the city / state field."
								   value="<%=addr1%>">
							<span class="focus-input100"></span>
						</div>
						<div class="tableBox">
							<label for="d_zipcode">
								<div class="labelInnerBox">
									<span class="inputTitle">ZIP code</span>
								</div>
							</label>
							<input type="text" name="d_zipcode" id="d_zipcode" placeholder="Enter ZIP code"
								   check="T" check_type="length" check_length="0" check_key=""
								   title="Please fill in the ZIP code field."
								   value="<%=zipcode%>">
							<span class="focus-input100"></span>
						</div>
						<div class="tableBox">
							<label for="d_mobile">
								<div class="labelInnerBox">
									<span class="inputTitle">Mobile Phone</span>
								</div>
							</label>
							<input type="text" name="d_mobile" id="d_mobile" placeholder="Enter Mobile Phone"
								   check="T" check_type="length" check_length="0" check_key=""
								   title="Please fill in the mobile phone field."
								   maxLength="20" value="<%=ord_mobile%>">
							<span class="focus-input100"></span>
						</div>
						<div class="tableBox">
							<label for="d_email">
								<div class="labelInnerBox">
									<span class="inputTitle">E-Mail</span>
								</div>
							</label>
							<input type="text" name="d_email" id="d_email" placeholder="Enter E-Mail"
								   check="T" check_type="length" check_length="0" check_key=""
								   title="Please fill in the E-Mail field."
								   maxLength="100" value="<%=ord_email%>">
							<span class="focus-input100"></span>
						</div>
					</div>
				</div>
				<%
				product_cd = Request("product_cd")
				sub_amt = 0	: sub_pv1 = 0 : tot_amt = 0	: deli_sum = 0 : tot_ord = 0
				sql =		"select	a.product_cd, a.product_name, b.amt, b.pv1, b.pv2,	"
				sql = sql & "		b.price, b.vat										"
				sql = sql & "  from	product a, product_detail b							"
				sql = sql & " where	a.product_cd = b.product_cd							"
				sql = sql & "   and	b.reg_date = (select max(reg_date)					"
				sql = sql & "						from product_detail					"
				sql = sql & "					   where product_cd = a.product_cd)		"
				sql = sql & "   and	a.product_cd = '" & product_cd & "'					"
				Set rs=DBConn.Execute(sql)

				qty			 = 1
				product_cd	 = rs("product_cd")
				product_name = rs("product_name")
				price		 = rs("price")
				vat			 = rs("vat")
				pdt_amt	= rs("amt")
				pdt_pv1	= rs("pv1")
				sub_amt = sub_amt + CCur(pdt_amt) * qty
				sub_pv1 = sub_pv1 + CCur(rs("pv1")) * qty

				deli_amt	 = 0
				If  isnull(deli_amt) Then deli_amt=0 Else deli_amt=CDbl(deli_amt) End If
				'배송비의 합
				deli_sum	= deli_sum + deli_amt

				'단가의 합
				tot_amt		= tot_amt + sub_amt
				'포인트의 합
				tot_pv1		= tot_pv1 + sub_pv1

				tot_coin	= CCur(tot_amt) * 1

				rs.Close : Set rs = Nothing

				tot_ord = tot_amt
				%>
				<input type="hidden" name="product_cd"	value="<%=product_cd%>"	/>
				<input type="hidden" name="product_name" value="<%=product_name%>" />
				<input type="hidden" name="price"		value="<%=price%>" />
				<input type="hidden" name="vat"			value="<%=vat%>" />
				<input type="hidden" name="qty"			value="<%=qty%>"	 id="qty" />
				<input type="hidden" name="pdt_amt"		value="<%=pdt_amt%>" id="pdt_amt" />
				<input type="hidden" name="pdt_pv1"		value="<%=pdt_pv1%>" />
				<input type="hidden" name="pdt_pv2"		value="<%=pdt_pv2%>" />
				<input type="hidden" name="order_kind"	value="4102">

				<input type="hidden" name="tot_amt"		value="<%=tot_ord%>" id="tot_amt" />
				<input type="hidden" name="tot_coin"	value="<%=tot_coin%>" id="tot_coin" />
				<input type="hidden" id="get_coin"		value="0" />
				<div class="orderRightBox">
					<div class="detailBox">
						<h3 class="productName">GTeXpress Package (<%=product_name%>)</h3>
						<div class="orderDataBox">
							<span class="orderDataName">Package type</span>
							<span class="orderData"><%=product_name%></span>
						</div>
						<div class="orderDataBox">
							<span class="orderDataName">Package price</span>
							<span class="orderData"><%=FormatNumber(tot_coin, 0)%> GTXp</span>
						</div>
						<div class="orderDataBox">
							<span class="orderDataName">My GTXp Balance</span>
							<span class="orderData"><span id="myGTXp">0</span> GTXp</span>
						</div>
						<div class="orderDataBox">
							<span class="orderDataName">GTXp balance after payment</span>
							<span class="orderData"><span id="afterGTXp">0</span> GTXp</span>
						</div>
						<div class="orderDataBox border-bottom">
							<span class="orderDataName">Payment type</span>
							<span class="orderData">
								<label>
									<input  type="radio" name="pay_kind" value="POINT" class="rdo_kind" checked
											title="Please select the payment method."
											check="T" check_type="length" check_length="0" check_key="" /> GTXp Point
								<label>
							</span>
						</div>
						<div class="btnPurchaseBox">
							<button type="button" class="btnPurchase" id="btnSend" style="display:none;">purchase</button>
						</div>
						<p class="purchaseText">&nbsp;</p>
					</div>
				</div>
				<div class="orderRightBox">
					<div class="detailBox">
						<h3 class="productName">Package components (<%=product_name%>)</h3>
						<%
						sql = 		"select  a.set_cd, a.qty,							"
						sql = sql & "        b.product_name,							"
						sql = sql & "        c.amt										"
						sql = sql & "  from  product_wip a, product b, product_detail c	"
						sql = sql & " where  a.set_cd = b.product_cd					"
						sql = sql & "   and  a.set_cd = c.product_cd					"
						sql = sql & "   and  a.product_cd = '" & product_cd & "'		"
						Set rs = DBConn.Execute(sql)
						Do While Not rs.EOF
							unit_name = rs("product_name") & " <span style=""color:blue;"">X " & FormatNumber(rs("qty"), 0) & "</span>"
							unit_price = rs("amt")
						%>
						<div class="orderDataBox">
							<span class="orderDataName"><%=unit_name%></span>
							<span class="orderData">Unit Price $<%=FormatNumber(unit_price, 2)%></span>
						</div>
						<%
							rs.MoveNext
						Loop
						rs.Close : Set rs = Nothing
						%>
					</div>
				</div>
			</div>
			</form>
		</div>
	</div>
</div>

<!-- #include virtual = "/myoffice/inc/footer.html" -->

<script>
$(document).ready(function() {
	live_point();
});

function live_point() { window.ref = window.setInterval(function() { get_amt(); }, 500); }

function get_amt() {
	clearInterval(window.ref);
	$.ajax('/myoffice/common/get_money.html',{
		success:function(data){

			var amt_temp = data.split("|");
			var tot_GTXp	 = amt_temp[0];

			$("#myGTXp").text(formatComma(tot_GTXp, 0));
			fnCalAmt(tot_GTXp);
		}
	});

	live_point();
}

function fnCalAmt(fNowAmt){
	$("#get_coin").val(fNowAmt);
	var regexp = /[^0-9]/gi;
	if (regexp.test(stripComma(fNowAmt))) {
		alert('Only digits available.');
		$("#afterGTXp").text(0);
		return false;
	} else {
		var tot_coin = Number($("#tot_coin").val());
		var afterGTXp = Number(fNowAmt) - tot_coin;
		if (afterGTXp < 0) {
			$("#afterGTXp").css("color", "red");
			$("#btnSend").css("display", "none");
		} else {
			$("#afterGTXp").css("color", "");
			$("#btnSend").css("display", "");
		}
		$("#afterGTXp").text(formatComma(afterGTXp, 0));
	}
}

$("#btnSend").on("click", function(){
	var tot_coin = Number($("#tot_coin").val());
	var get_coin = Number($("#get_coin").val());

	if (get_coin < tot_coin) {
		alert("Insufficient balance");
		return false;
	} else {
		if (confirm("Would you like to purchase?")) {
			var url = "/myoffice/common/order_proc.html";
			var data = $("#frm_order").serializeObject();

			$.ajax({
				url : url,
				global :false,
				contentType : "application/x-www-form-urlencoded; charset=euc-kr",
				type : "POST",
				data : data,
				dataType: 'text',
				crossDomain: true,
				async:false,
				success:function(rtnData){
					var arrItem = rtnData.split("|");
					var rtnState= arrItem[0];
					var rtnMsg 	= arrItem[1].replace(/\\n/g, '\n');
					var	rtnOrd 	= arrItem[2];

					if (rtnState == "SUCCESS") {
						alert(rtnMsg);
						location.href="/myoffice/order/order_complete.html?order_no="+rtnOrd;
					} else {
						alert(rtnMsg);
					}
				},
				error:function(reponse,textStatus,errorThrown){
					alert("Sorry!!! Some errors are occurred.\n\nPlease try again later.\n\nThank you.");
				},
				beforeSend:function(){
				}
			});
		}
	}
});
</script>