<!-- #include virtual="/myoffice/common/common.inc" -->
<!-- #include virtual="/myoffice/common/jsonObject.class.asp"-->
<%
page	= Request("page") 			: If page = "" Then page = 0				'// get the requested page
pageSize	= Request("pageSize")	: If pageSize = "" Then pageSize = 10		'// get how many list we want to have into the grid

userid		= Request("userid")

bbs_kind	= Request("bbs_kind")
bbs_cate	= UnEscape(Request("bbs_cate"))
srch_key	= Request("srch_key")
srch_val	= UnEscape(Request("srch_val"))

' where
If srch_val <> "" Then
	Select Case srch_key
	Case "name"		: srch_sql = "   and username	like '%" & srch_val	& "%'"
	Case "subject"	: srch_sql = "   and subject	like '%" & srch_val	& "%'"
	Case "content"	: srch_sql = "   and content	like '%" & srch_val & "%'"
	Case Else		: srch_sql = ""
	End Select
End If
' // where

	sql =		"select /*+ INDEX_DESC(web_bbs web_bbs_idx1)*/				"
	sql = sql & "		sid, grp, seq, lev, foreword, subject, username,	"
	sql = sql & "		To_Char(work_date,'yyyy-mm-dd') as work_date,		"
	sql = sql & "		isSecret, ip_addr, visit,file1_name	,answer_status,	"
	sql = sql & "		bbs_cate, top_noti									"
	sql = sql & "  from web_bbs												"
	sql = sql & " where	bbs_kind = '" & bbs_kind & "'						"
	If bbs_cate <> "" Then
	sql = sql & "   and	bbs_cate in ('전체공지', '" & bbs_cate & "')		"
	End If
	If bbs_type = "P" And session("admin") = "" Then
	sql = sql & "   and userid='"&session("userid")&"'						"
	End If
	sql = sql & srch_sql
	sql = sql & " order by grp desc, seq									"
'	sql = sql & strWhere
'	sql = sql & " order by " & sidx & " " & sord

	Set rs = Server.CreateObject("ADODB.RecordSet")
	rs.cursortype = 3
	rs.Open sql, DBConn

	TotRecord	= rs.RecordCount

	Set jsonPage = New JSONobject
	If CInt(pageSize) <> 0 Then
		rs.PageSize	= pageSize

		jsonPage.Add "currentPage"   , page
		jsonPage.Add "pageSize"      , pageSize
		jsonPage.Add "totalElements" , TotRecord
		jsonPage.Add "totalPages"    , rs.PageCount

		If Not rs.EOF And Not rs.BOF Then
			rs.AbsolutePage = page + 1
		End If

		Rcount = pageSize
	Else
		Rcount = TotRecord
	End If
	sql =		"select /*+ INDEX_DESC(web_bbs web_bbs_idx1)*/						"
	sql = sql & "		sid, grp, seq, lev, foreword, subject, username, 			"
	sql = sql & "		To_Char(work_date,'yyyy-mm-dd') as work_date,answer_status,	"
	sql = sql & "		bbs_cate, top_noti											"
	sql = sql & "  from	web_bbs														"
	sql = sql & " where bbs_kind = '" & bbs_kind & "'								"
	sql = sql & "   and top_noti ='1'												"
	If bbs_type = "P" And session("admin") <> "" Then
	sql = sql & "   and userid='" & session("userid") & "'							"
	End If
	If bbs_cate <> "" Then
	sql = sql & "   and	bbs_cate in ('전체공지', '" & bbs_cate & "')				"
	End If
	sql = sql & " order by sid desc													"
	Set rs_n = DBConn.Execute(sql)

	Set jsonList = New JSONarray 
	While Not rs_n.EOF And (Rcount > 0 )

		top_noti	= rs_n("top_noti")
		sid			= rs_n("sid")
		grp			= rs_n("grp")
		seq			= rs_n("seq")
		lev			= rs_n("lev")
		foreword	= rs_n("foreword")
		subject		= rs_n("subject")
			subject = cut_string(subject,100)
			If Not (IsNull(foreword)) Then subject = "[" & foreword & "]" & subject
'		subject		= "<i class=""fa fa-volume-up"" aria-hidden=""true""></i> " & subject
		username	= rs_n("username")
		work_date	= rs_n("work_date")
		answer_status = rs_n("answer_status")
		'visit		= rs_n("visit")
		'ip_addr		= rs_n("ip_addr")
'		isSecret	= rs_n("isSecret")
'		file1_name	= rs_n("file1_name")
		repl_badge	= ""
		bbs_cate	= rs_n("bbs_cate")

        Set jsonItem = New JSONobject

		jsonItem.Add "tempNo"		, "TOP"
		jsonItem.Add "top_noti"    	, top_noti
		jsonItem.Add "sid"      	, sid
		jsonItem.Add "seq"      	, seq
		jsonItem.Add "subject"    	, subject
		jsonItem.Add "visit"		, visit
		jsonItem.Add "work_date"   	, work_date
		jsonItem.Add "username"		, username
		jsonItem.Add "bbs_cate"		, bbs_cate
		jsonList.Push jsonItem

	    rs_n.MoveNext
    Wend
	rs_n.Close	: Set rs_n = Nothing

	tempNo			= TotRecord-(page)*(Rcount)		'레코드번호로 사용할 임시번호

    While Not rs.EOF And (Rcount > 0 )
		top_noti	= rs("top_noti")
		sid			= rs("sid")
		grp			= rs("grp")
		seq			= rs("seq")
		lev			= rs("lev")
		foreword	= rs("foreword")
		subject		= rs("subject")
			subject = cut_string(subject,100)
			If Not (IsNull(foreword)) Then subject = "[" & foreword & "]" & subject
		username	= rs("username")
		work_date	= rs("work_date")
		answer_status = rs("answer_status")
		visit		= rs("visit")
		ip_addr		= rs("ip_addr")
		isSecret	= rs("isSecret")
		file1_name	= rs("file1_name")
		repl_badge	= ""
		bbs_cate	= rs("bbs_cate")

        Set jsonItem = New JSONobject

		jsonItem.Add "tempNo"		, tempNo
		jsonItem.Add "top_noti"	    , top_noti
		jsonItem.Add "sid"	      	, sid
		jsonItem.Add "seq"	      	, seq
		jsonItem.Add "subject"	    , subject
		jsonItem.Add "visit"		, visit
		jsonItem.Add "work_date"	, work_date
		jsonItem.Add "username"		, username
		jsonItem.Add "bbs_cate"		, bbs_cate
		jsonItem.Add "isSecret"		, isSecret
		jsonList.Push jsonItem

		Rcount	= Rcount - 1
		tempNo	= tempNo - 1
	    rs.MoveNext
    Wend

	Set jsonParse = New JSONobject
	jsonParse.Add "page", jsonPage
	jsonParse.Add "list", jsonList

	jsonParse.Write()

rs.Close		: Set rs = Nothing
DBConn.Close	: Set DBConn = Nothing
%>