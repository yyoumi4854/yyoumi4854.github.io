<!-- #include virtual = /myoffice/common/common.inc -->
<!-- #include virtual = /inc/head.html -->
<!-- #include virtual = "/inc/header.html" -->
<link rel="stylesheet" href="/css/summernote-lite.css">
<link href="/css/jquery.growl.css" rel="stylesheet" type="text/css">
<link href="/css/fileup.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="/js/summernote/summernote-lite.min.js"></script>
<script type="text/javascript" src="/js/sweetalert.min.js"></script>
<script src="/js/jquery.growl.js"></script>
<script src="/js/fileup.js"></script>
<%
product_cd = Request("product_cd")
%>
<div class="review">
	<div class="title">
		<h2>REVIEW</h2>
	</div>

	<div class="write_con">
		<div class="inner">
			<h3>WRITE A REVIEW</h3>
			<%
			sql = 		"select a.product_name, a.model_name, 		"
			sql = sql & "		b.img_l 							"
			sql = sql & "  from product a, pdt_webinfo b			"
			sql = sql & " where a.product_cd = b.product_cd 		"
			sql = sql & "   and a.product_cd = '" & product_cd & "' "
			Set rs = DBConn.Execute(sql)

			If Not rs.EOF Then
				product_name= rs("product_name")
				model_name 	= rs("model_name")
				product_img = rs("img_l")
			%>
			<div class="pro_txt">
				<img src="<%=product_img%>" alt="<%=product_name%>">
				<p>
					<span><%=product_name%></span>
					<span><%=model_name%></span>
				</p>
			</div>
			<%
			End If
			rs.Close : Set rs = Nothing
			%>
			<p>*Please note that inquiries or malicious slander will be deleted without notice.</p>

			<div class="rev_txt_con">
				<div class="img_wrap">
					<form id="multiple" class="multiple">
						<a class="control-button btn" style="display: none"
						href="javascript:$.fileup('upload-2', 'upload', '*')">Upload all</a>
						<a class="control-button btn btn-link" style="display: none"
						href="javascript:$.fileup('upload-2', 'remove', '*')">Remove all</a>
						<div id="upload-2-queue" class="queue"></div>
					</form>
				</div>
				<div class="top">
					<!--
					<button type="button">
						<span>ADD AN IMAGE</span>
						<img src="../img/review/add_img.jpg" alt="">
					</button>
					-->
					<button type="button" class="btn fileup-btn">
						<span>ADD AN IMAGE</span>
										<img src="../img/review/add_img.jpg" alt="">
						<input type="file" id="upload-2" multiple>
					</button>

					<div class="select_star">
						<a href="#">
							<span>
								<i class="fas fa-star"></i>
								<i class="fas fa-star"></i>
								<i class="fas fa-star"></i>
								<i class="fas fa-star"></i>
								<i class="fas fa-star"></i>
							</span>
							<img src="../img/review/star_arrow.png" alt="">
						</a>
						<div class="star_list" style="z-index:1;">
							<p class="item">
								<span>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
								</span>
							</p>

							<p class="item">
								<span>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
								</span>
							</p>

							<p class="item">
								<span>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
								</span>
							</p>

							<p class="item">
								<span>
									<i class="fas fa-star"></i>
									<i class="fas fa-star"></i>
								</span>
							</p>

							<p class="item">
								<span>
									<i class="fas fa-star"></i>
								</span>
							</p>
						</div>
					</div>
				</div>
				<form id="frmReview">
				<input type="hidden" name="product_cd" id="product_cd" value="<%=product_cd%>" />
				<input type="hidden" name="score" id="score" value="5" />
				<!--<textarea></textarea>-->
				<div style="margin-top:10px;">
					<input type="hidden" id="review_content" name="review_content" class="m_data"
							title="Please check the content to be registered."
							check='F' check_type='length' check_length='0' check_key='' />
					<div id="review_contents_area" name="review_contents_area"><%=content%></div>
				</div>
				</form>
				<!--
				<div class="img_wrap">
					<div class="img_list">
						<img src="../img/review/pro_info.jpg" alt="">
						<span class="img_close">
							<img src="../img/review/img_close.png" alt="">
						</span>
					</div>
					<div class="img_list">
						<img src="../img/review/pro_info.jpg" alt="">
						<span class="img_close">
							<img src="../img/review/img_close.png" alt="">
						</span>
					</div>
				</div>
				-->
				<div class="submit_btn">
					<button type="button" id="btnSend" onclick="fnContentWrite(this.id, '<%=frmAction%>');">SUBMIT REVIEW</button>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	$(function(){
		$(".select_star a").click(function(e){
			e.preventDefault();
			$(this).next().slideToggle();
		});

		$(".star_list p.item").click(function(e){
			$(this).parent().slideToggle();
			var spnHtml = $(this).html();
			$(".select_star a").html(spnHtml).append('<img src="../img/review/star_arrow.png" alt="">');
		});

		$('#review_contents_area').summernote({
			placeholder: 'Write your content here.',
			lang: 'en-US', // default: 'en-US', 'ko-KR'
			toolbar: [
				// [groupName, [list of button]]

				['style', ['bold', 'italic', 'underline', 'clear']],
				['misc', ['codeview', 'fullscreen']],
				['font', ['strikethrough', 'superscript', 'subscript']]
				['fontsize', ['fontsize']],
				['color', ['color']],
				['para', ['ul', 'ol', 'paragraph']],
				['height', ['height']]		],
			height: 400
		});
	});

	function fnContentWrite(_thisId, _action){
		var score = $(".select_star a span i").length;
		$("#score").val(score);
		var $btn_submit = $("#" + _thisId);
		var proc_ok = true;
		var $formName = $("#frmReview");
		var review_contents_area = 	$('#review_contents_area').summernote('code');
		$("#review_content").val(review_contents_area);
		if (review_contents_area == "<p><br></p>"){
			proc_ok = false;
			alert("내용을 확인 하세요.");
			return false;
		}
		if (!$formName.validation()){
			proc_ok = false;
			return false;
		}

		if (proc_ok) {
			$btn_submit.hide();
			var formData = $formName.serializeObject();
			var url = "/myoffice/json_data/review_reg_json.html";
			if (_action == "update"){url = "/myoffice/json_data/review_update_json.html";}

			//메인 데이터와 서브데이터 병합.
			var data = formData;
			$.post(url, data, function(jsonData) {
				var items = jsonData;
				if(items.status == "success"){
					swal(items.rtn_msg, "확인을 누르시면 상품리뷰 페이지로 이동합니다.", "success").then(function(value) {
						location.replace('/review/review.html');
					});

					return;
				} else {
					swal("확인 후 다시 시도하시기 바랍니다.", items.rtn_msg.replace(/\\n/g, '\n'), "error").then(function(value) {
						return false;
					});
				}
			}, 'json')
			.fail(function(jsonData){
				alert("error");
				$btn_submit.show();
			});
		}
	}

	$.fileup({
		url: '/myoffice/json_data/system_file_reg_json_utf_8.html',
		inputID: 'upload-2',
		dropzoneID: 'upload-2-dropzone',
		queueID: 'upload-2-queue',
		onSelect: function(file) {
			$('#multiple .control-button').show();
		},
		onRemove: function(file, total) {
			fnFileDel(file);
			if (file === '*' || total === 1) {
				$('#multiple .control-button').hide();
			}
		},
		onSuccess: function(response, file_number, file) {
			console.log(response, file_number, file);
			if (typeof response !== 'object') {
				response = JSON.parse(response);
			}
			fnFileFormAdd(response.files[0], file_number);
			$.growl.notice({ title: "Upload success!", message: file.name });
		},
		onError: function(event, file, file_number) {
			$.growl.error({ message: "Upload error!" });
		}
	});

	function fnFileFormAdd(_response, _file_number){
		var product_cd = $('<input type="text" id="upFileIdx_' + _file_number + '" name="upFileIdx" value="' + _response.Idx + '" />');
		$('#frmReview').append(product_cd);
	}

	function fnFileDel(_file){
		if (_file === '*'){
			$('input[name=upFileIdx]').each(function(){
				var $upFileIdx = $(this);
				$.post("/myoffice/json_data/system_file_del_json.html", {idx: $upFileIdx.val()},
					function (resp,textStatus, jqXHR) {
						if (typeof resp !== 'object') {
							resp = JSON.parse(resp);
						}
						if(resp.rtn_state == 'success'){
							$.growl.notice({ title: "Delete success!", message: "Delete success!" });
						}
					});
				$upFileIdx.remove();
			});
		} else {
			var $upFileIdx = $('#upFileIdx_' + _file.file_number);
			$.post("/myoffice/json_data/system_file_del_json.html", {idx: $upFileIdx.val()},
				function (resp,textStatus, jqXHR) {
					if (typeof resp !== 'object') {
						resp = JSON.parse(resp);
					}
					if(resp.rtn_state == 'success'){
						$.growl.notice({ title: "Delete success!", message: "Delete success!" });
					}
				});
			$upFileIdx.remove();
		}
	}
</script>
<!-- #include virtual = /inc/foot.html -->
