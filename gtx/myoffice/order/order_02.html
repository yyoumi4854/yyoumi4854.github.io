<%@ CodePage="65001" Language="vbscript"%>
<!-- #include virtual = "/myoffice/common/common.inc" -->

<!-- #include virtual = "/myoffice/inc/head.html" -->

<!-- #include virtual = "/myoffice/inc/header.html" -->

<!-- #include virtual = "/myoffice/inc/nav.html" -->
<% Call Check_Login(fURL) %>
<div id="container">
	<div class="contentHeader">
		<h3 class="contentTitle"><i class="fa fa-th-large" aria-hidden="true"></i> Order</h3>
	</div>
	<div class="content">
		<div class="section">
			<form name="frm_order" id="frm_order">
			<div class="orderBox">
				<%
				sql =		"select	a.username,a.zipcode,a.e_mail, country,														"
				sql = sql & "  ENCRYPTION_AES.DEC_AES(a.mobile) as mobile, ENCRYPTION_AES.DEC_AES(a.address1) as  address1,		"
				sql = sql & "  ENCRYPTION_AES.DEC_AES(a.address2) address2														"
				sql = sql & "  from	dist A																						"
				sql = sql & " where	A.userid = '" & Session("userid") & "'														"
				Set rs_u = DBConn.Execute(sql)

				username	= rs_u("username")
				If InStr(username, ",") > 0 Then
					arryName	= Split(username, ",")
					lastname	= arryName(0)
					firstname	= arryName(1)
				Else
					firstname	= username
				End If

				ord_mobile	= rs_u("mobile")

				country		= rs_u("country")
				zipcode		= rs_u("zipcode")
				addr1		= rs_u("address1")
				addr2		= rs_u("address2")

				ord_email	= rs_u("e_mail")
				email_temp	= fn_normal(ord_email,"@","MAIL")
				email		= Split(email_temp,",")

				rs_u.Close : Set rs_u = Nothing
				%>
				<input  type="hidden" name="userid" id="userid" value="<%=Session("userid")%>" />
				<input  type="hidden" name="user_name" id="user_name" value="<%=username%>" />
				<input	type="hidden" name="user_mobile" id="user_mobile" class="tel" value="<%=ord_mobile%>" />
				<input  type="hidden" name="user_zip"	id="user_zip"	value="<%=zip_code%>"  />
				<input	type="hidden" name="user_addr1" id="user_addr1" value="<%= ADDR1 %>" />
				<input	type="hidden" name="user_addr2" id="user_addr2" value="<%= ADDR2 %>" />
				<input  type="hidden" name="user_email"	value="<%= ord_email %>">
				<div class="orderLeftBox">
					<div class="detailBox">
						<h3 class="productName">Ship to</h3>
						<div class="tableBox">
							<label for="d_country">
								<div class="labelInnerBox">
									<span class="inputTitle">Country</span>
								</div>
							</label>
							<select name="d_country" id="d_country"
									check="F" check_type="length" check_length="0" check_key=""
									title="Please select the country field.">
								<%
								sql =		"select	country, country_name	"
								sql = sql & "  from	country					"
								sql = sql & " where	isUSE = '1'				"
								sql = sql & " order by country				"
								Set rs_country = DBConn.Execute(sql)

								Do While Not rs_country.EOF
									Response.Write "<option value='" & rs_country("country") & "'>" & rs_country("country_name") & "</option>"
									rs_country.MoveNext
								Loop
								rs_country.Close
								%>
							</select>
							<span class="focus-input100"></span>
							<script>$("#d_country").val("<%=country%>");</script>
						</div>
						<div class="tableBox">
							<label for="d_firstname">
								<div class="labelInnerBox">
									<span class="inputTitle">First Name</span>
								</div>
							</label>
							<input type="text" name="d_firstname" id="d_firstname" placeholder="Enter First Name"
								   check="F" check_type="length" check_length="0" check_key=""
								   title="Please fill in the firstname field."
								   value="<%=firstname%>">
							<span class="focus-input100"></span>
						</div>
						<div class="tableBox">
							<label for="d_lastname">
								<div class="labelInnerBox">
									<span class="inputTitle">Last Name</span>
								</div>
							</label>
							<input type="text" name="d_lastname" id="d_lastname" placeholder="Enter Last Name"
								   check="F" check_type="length" check_length="0" check_key=""
								   title="Please fill in the lastname field."
								   value="<%=lastname%>">
							<span class="focus-input100"></span>
						</div>
						<div class="tableBox" style="display:none;">
							<label for="d_addr2">
								<div class="labelInnerBox">
									<span class="inputTitle">Street address</span>
								</div>
							</label>
							<input type="text" name="d_addr2" id="d_addr2" placeholder="Enter Street address"
								   check="F" check_type="length" check_length="0" check_key=""
								   title="Please fill in the Street address field."
								   value="<%=addr2%>">
							<span class="focus-input100"></span>
						</div>
						<div class="tableBox" style="display:none;">
							<label for="d_addr1">
								<div class="labelInnerBox">
									<span class="inputTitle">City / State</span>
								</div>
							</label>
							<input type="text" name="d_addr1" id="d_addr1" placeholder="Enter City / State"
								   check="F" check_type="length" check_length="0" check_key=""
								   title="Please fill in the city / state field."
								   value="<%=addr1%>">
							<span class="focus-input100"></span>
						</div>
						<div class="tableBox">
							<label for="d_zipcode">
								<div class="labelInnerBox">
									<span class="inputTitle">ZIP code</span>
								</div>
							</label>
							<input type="text" name="d_zipcode" id="d_zipcode" placeholder="Enter ZIP code"
								   check="F" check_type="length" check_length="0" check_key=""
								   title="Please fill in the ZIP code field."
								   value="<%=zipcode%>">
							<span class="focus-input100"></span>
						</div>
						<div class="tableBox">
							<label for="d_mobile">
								<div class="labelInnerBox">
									<span class="inputTitle">Mobile Phone</span>
								</div>
							</label>
							<input type="text" name="d_mobile" id="d_mobile" placeholder="Enter Mobile Phone"
								   check="F" check_type="length" check_length="0" check_key=""
								   title="Please fill in the mobile phone field."
								   maxLength="20" value="<%=ord_mobile%>">
							<span class="focus-input100"></span>
						</div>
						<div class="tableBox">
							<label for="d_email">
								<div class="labelInnerBox">
									<span class="inputTitle">E-Mail</span>
								</div>
							</label>
							<input type="text" name="d_email" id="d_email" placeholder="Enter E-Mail"
								   check="F" check_type="length" check_length="0" check_key=""
								   title="Please fill in the E-Mail field."
								   maxLength="100" value="<%=ord_email%>">
							<span class="focus-input100"></span>
						</div>
					</div>
				</div>
				<%
				sub_amt = 0	: sub_pv1 = 0 : tot_amt = 0	: deli_sum = 0 : tot_ord = 0
				sql =		"select	a.product_cd, a.product_name, b.amt, b.pv1, b.pv2,	"
				sql = sql & "		b.price, b.vat										"
				sql = sql & "  from	product a, product_detail b							"
				sql = sql & " where	a.product_cd = b.product_cd							"
				sql = sql & "   and	b.reg_date = (select max(reg_date)					"
				sql = sql & "						from product_detail					"
				sql = sql & "					   where product_cd = a.product_cd)		"
				sql = sql & "   and	a.product_cd = '0000'								"
				Set rs=DBConn.Execute(sql)

				qty			 = 1
				min_amount	 = 10
				product_cd	 = rs("product_cd")
				product_name = rs("product_name")
				price		 = rs("price")
				vat			 = 0
				pdt_amt	= rs("amt")
				pdt_pv1	= 0
				sub_amt = sub_amt + CCur(pdt_amt) * qty
				sub_pv1 = sub_pv1 + CCur(rs("pv1")) * qty

				deli_amt	 = 0
				If  isnull(deli_amt) Then deli_amt=0 Else deli_amt=CDbl(deli_amt) End If
				'배송비의 합
				deli_sum	= deli_sum + deli_amt

				'단가의 합
				tot_amt		= tot_amt + sub_amt
				'포인트의 합
				tot_pv1		= tot_pv1 + sub_pv1

				rs.Close : Set rs = Nothing

				tot_ord = tot_amt
				pdt_point = min_amount * 1
				%>
				<input type="hidden" name="product_cd"	value="<%=product_cd%>"	/>
				<input type="hidden" name="product_name" value="<%=product_name%>" />
				<input type="hidden" name="price"		value="<%=price%>" />
				<input type="hidden" name="vat"			value="<%=vat%>" />
				<input type="hidden" name="qty"			value="<%=qty%>"	 id="qty" />
				<input type="hidden" name="pdt_amt"		value="<%=pdt_amt%>" id="pdt_amt" />
				<input type="hidden" name="pdt_pv1"		value="<%=pdt_pv1%>" />
				<input type="hidden" name="pdt_pv2"		value="<%=pdt_pv2%>" />
				<input type="hidden" name="order_kind"	value="4101">

				<input type="hidden" name="tot_amt"		value="<%=tot_ord%>" id="tot_amt" />
				<input type="hidden" name="point_amt"	value="0"			 id="point_amt" />
				<input type="hidden" name="ab_cd"		value="2" />
				<div class="orderRightBox">
					<div class="detailBox">
						<h3 class="productName"><%=product_name%></h3>
						<div class="orderDataBox">
							<span class="orderDataName">Point ratio</span>
							<span class="orderData">$1.00 = <span id="live_gtxp">1<span> GTXp</span>
						</div>
						<div class="orderDataBox border-bottom">
							<span class="orderDataName">
								Deposit amount <span style="color:red;">Minimum purchase amount is $<%=FormatNumber(pdt_amt, 0)%></span>
							</span>
							<span class="orderData">$ 
								<input type="number" name="amount" id="amount" value="<%=pdt_amt%>" min="10" onkeyup="fnCalc(this.value);" style="max-width:70%;" />
							</span>
						</div>
						<div class="orderDataBox border-bottom">
							<span class="orderDataName">Deposit GTXp</span>
							<span class="orderData"><span id="tot_amt_point"><%=FormatNumber(pdt_point, 0)%></span> GTXp</span>
						</div>
						<div class="orderDataBox border-bottom">
							<span class="orderDataName">Total</span>
							<span class="orderData"><span id="tot_amt_usd"><%=FormatNumber(sub_amt, 2)%></span> USD</span>
						</div>
						<div class="orderDataBox border-bottom">
							<span class="orderDataName">Payment type</span>
							<span class="orderData">
								<label>
									<input  type="radio" name="pay_kind" value="BANK" class="rdo_kind" checked
											title="Please select the payment method."
											check="T" check_type="length" check_length="0" check_key="" />BANK (USD)
								<label>
							</span>
						</div>
						<div class="btnPurchaseBox">
							<button type="button" class="btnPurchase">Purchase</button>
						</div>
						<p class="purchaseText">&nbsp;</p>
					</div>
				</div>
			</div>
			</form>
		</div>
	</div>
</div>

<!-- #include virtual = "/myoffice/inc/footer.html" -->

<div id="purchasePopup" style="display:none;">
	<h1 class="purchasePopupTitle">Bank account number</h1>
	<div class="purchasePopupContent">
		<div class="addressContentBox qr cBANK">
			<dl class="addressContentInner">
				<dt class="bankAccount">Bank Direct Deposit</dt>
				<dd class="addressNotice">To deposit the payment for your order, please copy the address below.</dd>
				<dd class="bankAddr">
					<div>
						<%
						sql = "select ab_account, ab_name, ab_depositor from admit_bank Where isuse = '1' and ab_cd = 2"
						Set rs_ab = DBConn.Execute(sql)
						If Not rs_ab.EOF Then
							ab_account 	= rs_ab("ab_account")
							ab_name 	= rs_ab("ab_name")
							ab_depositor= rs_ab("ab_depositor")
						End If
						%>
						<span class="bankAddrText"><%=ab_account%></span>
						<button type="button" class="btnBankAddrCopy" data-clipboard-action="copy" data-clipboard-text="<%=ab_account%>">Copy</button>
						<span class="bankAddrText"><%=" / " & ab_name & " / " & ab_depositor%></span>
					</div>
				</dd>
			</dl>
		</div>
		<div class="addressContentBox">
			<div class="btnPopupBox">
				<!--/myoffice/order/order_complete.html-->
				<a href="javascript:void(0);" id="btnSend" class="btnPopupOkay">OK</a>
				<a href="#purchasePopup" rel="modal:close" class="btnPopupCancel">Cancel</a>
			</div>
		</div>
	</div>
</div>

<script>
$(document).ready(function(){
	var clipboard = new Clipboard(".btnBankAddrCopy");
	clipboard.on('success',function(e) {
		e.clearSelection();
		showTooltip(e.trigger,'Copied!');
	});
	clipboard.on("error", function(e){
		alert("Unable to copy!");
	});
});
$("#btnSend").on("click", function(){
	var url = "/myoffice/common/order_proc.html";
	var data = $("#frm_order").serializeObject();

	$.ajax({
		url : url,
		global :false,
		contentType : "application/x-www-form-urlencoded; charset=euc-kr",
		type : "POST",
		data : data,
		dataType: 'text',
		crossDomain: true,
		async:false,
		success:function(rtnData){
			var arrItem = rtnData.split("|");
			var rtnState= arrItem[0];
			var rtnMsg 	= arrItem[1].replace(/\\n/g, '\n');
			var	rtnOrd 	= arrItem[2];

			if (rtnState == "SUCCESS") {
				alert(rtnMsg);
				location.href="/myoffice/order/order_complete.html?order_no="+rtnOrd;
			} else {
				alert(rtnMsg);
			}
		},
		error:function(reponse,textStatus,errorThrown){
			alert("Sorry!!! Some errors are occurred.\n\nPlease try again later.\n\nThank you.");
		},
		beforeSend:function(){
		}
	});
});

$(".btnPurchase").on("click", function(){
	var proc_ok = "T";
	var tot_amt = Number($("#tot_amt").val());

	if (tot_amt >= 10){
		proc_ok = "T";
	} else {
		alert("주문금액이 $10 이하는 주문 할 수 없습니다.");
		$("#amount").focus();
		proc_ok = "F";
		return false;
	}

	if (!$("#frm_order").validation()){
		proc_ok = "F";
		return false;
	}

	if (proc_ok == "T"){
		$("#purchasePopup").modal("show");
	}
});

function fnCalc(_value){
	$('#point_amt, #tot_amt').val(_value);
	$('#tot_amt_point').text(numeral(_value).format('0,0'));
	$('#tot_amt_usd').text(numeral(_value).format('$0,0.00'));
}
</script>