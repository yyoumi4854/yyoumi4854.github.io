<!-- #include virtual="/myoffice/common/common.inc" -->
<!-- #include virtual="/myoffice/common/jsonObject.class.asp"-->
<%
'On Error Resume Next

work_user	= "WEB"

page		= Request("page") 		: If page = "" Then page = 0				'// get the requested page
pageSize	= Request("pageSize")	: If pageSize = "" Then pageSize = 10		'// get how many rows we want to have into the grid

st_date		= Trim(Request.Form("st_date"))
ed_date		= Trim(Request.Form("ed_date"))
srch_key	= Trim(Request.Form("srch_key"))
srch_val	= Replace(Trim(Request.Form("srch_val")), " ", "")
is_end		= Trim(Request.Form("is_end"))

If srch_val <> "" Then
	addSQL = addSQL & " and " & srch_key & " like '%" & srch_val & "%' "
End If

If st_date <> "" Then
	addSQL = addSQL & " and to_char(work_date, 'yyyy-mm-dd') >= '" & st_date & "' "
End If

If ed_date <> "" Then
	addSQL = addSQL & " and to_char(work_date, 'yyyy-mm-dd') <= '" & ed_date & "' "
End If

sql = 		"select x.* from (															"
sql = sql &	"	select a.*,																"
sql = sql & "	  		b.product_name as link_products,								"
sql = sql & "	  		decode(a.isuse, '1', '사용', '미사용') as isuses,				"
sql = sql & "	  		CASE															"
sql = sql & "	  		   WHEN TO_DATE (open_end, 'yyyymmddhh24mi') < SYSDATE THEN '1'	"
sql = sql & "	  		   ELSE '0'														"
sql = sql & "	  		END																"
sql = sql & "	  		   AS is_end,													"
sql = sql & "	  		TO_CHAR(TO_DATE (open_start, 'yyyymmddhh24mi'),					"
sql = sql & "	  									'yyyy-mm-dd') as start_date,		"
sql = sql & "	  		TO_CHAR(TO_DATE (open_end, 'yyyymmddhh24mi'),					"
sql = sql & "	  									'yyyy-mm-dd') as end_date			"
sql = sql & "	  from web_event_info a, product b										"
sql = sql & "	 where idx is not null													"
sql = sql & "	   and a.link_product = b.product_cd(+)									"
sql = sql & addSQL
sql = sql & "	 order by idx desc														"
sql = sql & "	) x																		"
If is_end <> "" Then
	sql = sql & " where x.is_end = '" & is_end & "' "
End If
Set rs = Server.CreateObject("ADODB.RecordSet")
rs.cursortype = 3
rs.Open sql, DBConn

If CInt(pageSize) <> 0 Then
	rs.PageSize	= pageSize

	Set JSON = New JSONobject
    JSON.Add "currentPage", page
    JSON.Add "pageSize", pageSize
    JSON.Add "totalElements", rs.RecordCount
    JSON.Add "totalPages", rs.PageCount

	If Not rs.EOF And Not rs.BOF Then
		rs.AbsolutePage = page + 1
	End If

	Rcount = pageSize
Else
	Rcount = rs.RecordCount
End If

If Not rs.EOF And Not rs.BOF Then
	set JSONitems = New JSONarray
	While Not rs.EOF And Not rs.BOF And Rcount > 0
		Set JSONitem = New JSONobject
		For Each col In rs.Fields
			If LCase(col.Name) <> "srch_key" Then
				JSONitem.Add LCase(col.Name), col.Value
			End If
		Next
		JSONitems.Push JSONitem
		Set JSONitem = Nothing
		Rcount = Rcount - 1
		rs.MoveNext
	Wend

	rtn_state 	= "SUCCESS"
	rtn_msg 	= "사용가능 합니다."
Else
	rtn_state 	= "FAIL"
	rtn_msg 	= "데이터가 없습니다."
End If

Set JSONParse = New JSONobject

JSONParse.Add "page", JSON
JSONParse.Add "list", JSONitems
JSONParse.Write()

Set JSONParse = Nothing
Set JSONarr = Nothing
Set JSON = Nothing
rs.Close		: Set rs = Nothing
%>