<%@LANGUAGE="VBSCRIPT" CODEPAGE="65001"%>
<%
Session.CodePage = 65001
Response.CharSet = "utf-8"
%>
<!--#include virtual="/myoffice/common/db_connect.inc"-->
<!--#include virtual="/myoffice/common/function.inc"-->
<!--#include virtual="/myoffice/common/jsonObject.class.asp"-->
<!--#include virtual="/myoffice/common/freeaspupload.html" -->

<%
'Option Explicit

'====================파일 업로드 부분 ===========================
  Dim uploadsDirVar
  Dim Upload, fileName, ks, fileKey,webPath
  webPath = "/bbs/upload"
  uploadsDirVar =  Server.mappath(webPath)
  Set JSONFileArry = New JSONArray
  Set Upload = New FreeASPUpload
	'자동으로 전체 업로드
	Upload.Save(uploadsDirVar)
	ks = Upload.UploadedFiles.keys
	if (UBound(ks) <> -1) Then
		for each fileKey in Upload.UploadedFiles.keys
			set obj = new JSONobject
			obj.Add "FileName", Upload.UploadedFiles(fileKey).FileName
			obj.Add "ContentType", Upload.UploadedFiles(fileKey).ContentType
			obj.Add "Start", Upload.UploadedFiles(fileKey).Start
			obj.Add "Length", Upload.UploadedFiles(fileKey).Length
			'obj.Add "Path", Upload.UploadedFiles(fileKey).Path
			obj.Add "WebPath",webPath&"/"&Upload.UploadedFiles(fileKey).LocalFileName
			obj.Add "LocalFileName", Upload.UploadedFiles(fileKey).LocalFileName
			JSONFileArry.Push obj
		Next
	end If
'====================파일 업로드 부분 =============================

mutil_table = Trim(Upload.Form("mutil_table"))	: If mutil_table = "" Then mutil_table = "REVIEW"
mutil_type  = Trim(Upload.Form("mutil_type"))
mutil_idx_cd= Trim(Upload.Form("mutil_idx_cd"))

DBConn.BeginTrans

'Json arry 에서 데이터를 추출.
for i = 0 to JSONFileArry.length -1
	set item = JSONFileArry(i)

	Set seqRs = Server.CreateObject("ADODB.RecordSet")
	sql =		"select WEB_FILE_SEQ.nextval From dual"
	seqRs.Open sql, DBConn
	If Not(seqRs.eof Or seqRs.bof) Then
		fileIdx		= CInt(seqRs(0))
		item.add "Idx",fileIdx
	End If
	seqRs.Close		: Set seqRs = Nothing

	sql =		"insert into WEB_FILE (										"
	sql = sql & "		 IDX,              									"
	sql = sql & "		 MUTIL_TABLE,      									"
	sql = sql & "		 MUTIL_IDX_CD,     									"
	sql = sql & "		 MUTIL_TYPE,       									"
	sql = sql & "		 FILE_NAME,        									"
	sql = sql & "		 REAL_FILE_NAME,   									"
	sql = sql & "		 FILE_PATH,        									"
	'sql = sql & "		 FILE_FULL_PATH,   									"
	sql = sql & "		 FILE_EXT,         									"
	sql = sql & "		 FILE_SIZE,        									"
	sql = sql & "		 WORK_USER,        									"
	sql = sql & "		 WORK_DATE         									"
	sql = sql & ") values (															"
	sql = sql & "		'"	& fileIdx								& "',			"
	sql = sql & "		'"	& mutil_table							& "',			"
	sql = sql & "		'"	& mutil_idx_cd							& "',			"
	sql = sql & "		'"	& mutil_type							& "',			"
	sql = sql & "		'"	& item("FileName")						& "',			"
	sql = sql & "		'"	& item("LocalFileName")					& "',			"
	sql = sql & "		'"	& item("WebPath")						& "',			"
	'sql = sql & "		'"	& item("Path")							& "',			"
	sql = sql & "		'"	& item("ContentType")					& "',			"
	sql = sql & "		'"	& item("Length")						& "',			"
	sql = sql & "		'"	& session("admin")					& "',			"
	sql = sql & "		sysdate														"
	sql = sql & ")																	"

	'Response.Write sql
	DBConn.Execute(sql)


next


Dim msg

If Err.Number = 0 Then
	DBConn.CommitTrans
	rtn_msg = ""
	rtn_msg = msg & "등록 완료"
	rtn_state = "success"
Else
	DBConn.RollBackTrans
	rtn_msg = Err.Description '""
	rtn_msg = msg & "!!! 등록 실패 !!!"
	rtn_state = "failure"
End If

Set jsonResult = New JSONobject
jsonResult.add "rtn_msg" ,rtn_msg
jsonResult.add "rtn_state" ,rtn_state
jsonResult.add "files" ,JSONFileArry


jsonResult.Write()

DBConn.Close	: Set DBConn = Nothing
%>