<!-- #include virtual="/myoffice/common/common.inc" -->
<!-- #include virtual="/myoffice/common/jsonObject.class.asp"-->
<%
' On Error Resume Next
go_url		= Request("go_url")
product		= Replace(Request("product_cd")," ","")
arr_prod	= Split(product,",")
buy_kind	= Request("buy_kind")
order_kind	= Request("order_kind")	: If order_kind = "" Then order_kind = "4101"

qty			= Request("qty")		: If qty = "" Then qty = "1"
p_option	= Request("option")		: If p_option = "" Then p_option = "-"
work_type	= Request("work_type")	: If work_type = "" Then work_type = "NEW"

If work_type = "NEW" Then

	insert_cnt	= 0

	For I=0 To UBound(arr_prod)

		sql =	"Select	count(reg_no) as pd_cnt						" &_
				"  from	Web_Cart									" &_
				" where	userid		= '" & Session("userid") & "'	" &_
				"   and	order_kind	= '" & order_kind		 & "'	" &_
				"   and	product		= '" & arr_prod(I)		 & "'	"
		Set rs = DBConn.Execute(sql)

		If CInt(rs("pd_cnt")) = 0 Then

			DBConn.BeginTrans

			sql =	"Insert Into Web_Cart												" &_
					"	(reg_no, userid, product, qty, work_user, buy_kind, order_kind)	" &_
					"Values(															" &_
					"SHOP_CART_SEQ.nextval"			& ",								" &_
					"'" & Session("userid")			& "',								" &_
					"'" & arr_prod(I)				& "',								" &_
					"'" & qty						& "',								" &_
					"'" & Session("userid")			& "',								" &_
					"'" & buy_kind					& "',								" &_
					"'" & order_kind				& "')								"

			DBConn.Execute(sql)
			If DBConn.Errors.Count = 0 Then
				DBConn.CommitTrans
				insert_cnt	= insert_cnt + 1
			Else
				DBConn.RollBackTrans
			End If

		End If

		rs.Close
	Next

	If insert_cnt > 0 Then
		rtn_state	= "success"
		rtn_msg		= "장바구니에 상품이 등록되었습니다."
	Else
		rtn_state	= "fail"
		rtn_msg		= "이미 장바구니에 보관된 상품입니다.\n\n수량 변경을 하시려면 삭제 후 다시 추가 해주세요."
	End If

ElseIf work_type = "MOD" Then

	DBConn.BeginTrans

	sql =	"Update	Web_Cart									 " &_
			"   set	qty = "			& qty			 		& "	 " &_
			" where	userid	= '"	& Session("userid")	& "' " &_
			"   and	product	= '"	& arr_prod(0)			& "' "
	DBConn.Execute(sql)

	If DBConn.Errors.Count = 0 Then
		DBConn.CommitTrans
		rtn_state	= "success"
		rtn_msg		= ""
	Else
		DBConn.RollBackTrans
		rtn_state	= "fail"
		rtn_msg		= "수량 변경에 실패했습니다. 다시 시도해 주십시오."
	End If

ElseIf work_type = "DEL_P" Then
	DBConn.BeginTrans
	sql =		"Delete From Web_Cart				"
	sql = sql &	" where	product = '" & product & "'	"
	sql = sql & "	and userid = '" & Session("userid") & "'	"
	DBConn.Execute(sql)

	If DBConn.Errors.Count = 0 Then
		DBConn.CommitTrans
		rtn_state	= "success"
		rtn_msg		= "삭제 되었습니다."
	Else
		DBConn.RollBackTrans
		rtn_state	= "fail"
		rtn_msg		= "장바구니 삭제에 실패했습니다. 다시 시도해 주십시오."
	End If

ElseIf work_type = "DEL_A" Then

	DBConn.BeginTrans

	sql =	"Delete From Web_Cart							 " &_
			" where	userid	= '"	& Session("Userid") & "' "
	DBConn.Execute(sql)

	If DBConn.Errors.Count = 0 Then
		DBConn.CommitTrans
		rtn_state	= "success"
		rtn_msg		= "장바구니가 모두 삭제 되었습니다"
	Else
		DBConn.RollBackTrans
		rtn_state	= "fail"
		rtn_msg		= "장바구니 삭제에 실패했습니다. 다시 시도해 주십시오."
	End If

ElseIf work_type = "KIND" Then
	DBConn.BeginTrans

	sql =		"Update	Web_Cart											"
	sql = sql & "   set	buy_kind	= '"	& buy_kind			 	& "'	"

	If buy_kind = "P" Then
		sql = sql & "   	,qty = 1"
	End If

	sql = sql & " where	userid		= '"	& Session("userid")	& "'	"
	sql = sql &	"   and	product		= '"	& arr_prod(0)			& "'	"
	DBConn.Execute(sql)

	If DBConn.Errors.Count = 0 Then
		DBConn.CommitTrans
		rtn_state	= "success"
	Else
		DBConn.RollBackTrans
		rtn_state	= "fail"
		rtn_msg		= "구매방식 변경에 실패했습니다. 다시 시도해 주십시오."
	End If
End If

Set jsonResult = New JSONobject
jsonResult.Add "rtn_msg", 	rtn_msg
jsonResult.Add "rtn_state", rtn_state

If work_type = "NEW" And rtn_state = "success" Then
	sql = 		"select a.product_cd, a.product_name, a.model_name,	b.img_l,"
	sql = sql & "		c.amt 												"
	sql = sql & "  from product a, pdt_webinfo b, product_detail c			"
	sql = sql & " where a.product_cd = b.product_cd		 					"
	sql = sql & "	and a.product_cd = c.product_cd							"
	sql = sql & "	and a.product_cd = '" & product & "'					"
	Set rsPdt = DBConn.Execute(sql)

	If Not rsPdt.EOF Then
		product_cd 	= rsPdt("product_cd")
		product_name= rsPdt("product_name")
		model_name 	= rsPdt("model_name")
		amt 		= rsPdt("amt")
		img_l 		= rsPdt("img_l")
	End If
	rsPdt.Close	: Set rsPdt = Nothing
End If

sql = "select	count(0) as bagCnt from web_cart where userid = '" & Session("userid") & "'"
Set rsBag = DBConn.Execute(sql)
bagCnt = rsBag("bagCnt")
rsBag.Close	: Set rsBag = Nothing

Set jsonProduct = New JSONobject
jsonProduct.Add "product_cd", 	product_cd
jsonProduct.Add "product_name", product_name
jsonProduct.Add "product_model",model_name
jsonProduct.Add "img", img_l
jsonProduct.Add "amt", amt
jsonProduct.Add "qty", qty
jsonProduct.Add "bagCnt", bagCnt

Set JSONParse = New JSONobject
JSONParse.Add "rtnResult", 	jsonResult
JSONParse.Add "rtnProduct",	jsonProduct
JSONParse.Write()

Set JSONParse = Nothing
Set DBConn = Nothing
%>