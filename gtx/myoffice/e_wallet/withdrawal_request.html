<%@ CodePage="65001" Language="vbscript"%>
<!-- #include virtual = "/myoffice/common/common.inc" -->
<!-- #include virtual = "/myoffice/inc/head.html" -->

<!-- #include virtual = "/myoffice/inc/header.html" -->

<!-- #include virtual = "/myoffice/inc/nav.html" -->
<% Call Check_Login(fURL) %>
<script>
$(document).ready(function() {
	amt_check();
});
function amt_check() { window.ref = window.setInterval(function() { get_amt(); }, 500); }

function get_amt() {
	clearInterval(window.ref);
	$.ajax('/myoffice/common/get_money.html',{
		success:function(data){

			var amt_temp = data.split("|");
			var tot_GTXp = amt_temp[0];

			$("#tot_GTXp").text(formatComma(tot_GTXp, 0));
		}
	});

	amt_check();
}


function set_field(fKIND) {

	$(".bank_fld").hide(); $(".coin_fld").hide();

	$("#bank_name").attr("check","F");
	$("#bank_acc").attr("check","F");
	$("#bank_owner").attr("check","F");
	$("#bank_nation").attr("check","F");
	$("#bank_amt").attr("check","F");

	$("#req_amt").val("");
	$("#fee_amt").val("");
	$("#trans_amt").val("");
	$("#bank_amt").val("");

	$("." + fKIND + "_fld").show();

	if (fKIND == 'bank') {
		$("#bank_name").attr("check","T");
		$("#bank_acc").attr("check","T");
		$("#bank_owner").attr("check","T");
		$("#bank_nation").attr("check","T");
		$("#bank_amt").attr("check","T");
	}
}

function cal_amt() {

	var req_kind = $("input:radio[name='request_method']:checked").val();

	if ($("input:radio[name=request_method]:checked").length == 0) {
		alert('Please check withdrawal method, which you want to.');
		$("#req_amt").val("");
		return false;
	} else {

		var in_amt = $("#req_amt").val();

		regexp = /[^0-9]/gi;

		if (regexp.test(stripComma(in_amt))) {
			alert('Only digits available.');
			$("#req_amt").val("");
			$("#fee_amt").val("");
			$("#trans_amt").val("");
			return false;
		} else {

			var able_amt	= Number(stripComma($("#avail_amt").val()));
			var req_amt		= Number(stripComma(in_amt));
			var fee_rate	= 0.02;

			if (req_amt > able_amt) {
				alert("You cannot request over available amount.");
				$("#req_amt").val("");
				$("#fee_amt").val("");
				$("#trans_amt").val("");
				$("#bank_amt").val("");
				return false;
			} else if (req_amt < 50) {
				alert("Request amounts must be more than 50 Point.");
				$("#req_amt").val("");
				$("#fee_amt").val("");
				$("#trans_amt").val("");
				$("#bank_amt").val("");
				return false;
			} else {

				var fee_amt		= Math.round(req_amt * fee_rate * 100)/100;
				var final_amt	= req_amt - fee_amt;

				$("#fee_amt").val(fee_amt);
				$("#trans_amt").val(final_amt);

				if ($("input:radio[name=request_method]:checked").val() == "bank") {
					$("#bank_amt").val(final_amt.toFixed(2));
				}

				return true;

			}
		}
	}

}

</script>
<div id="container">
	<div class="contentHeader">
		<h3 class="contentTitle"><i class="fa fa-th-large" aria-hidden="true"></i> Withdrawal Request</h3>
	</div>
	<div class="content">
		<div class="section">
			<h3 class="sectionTitle">Money Balance</h3>
			<div class="innerBox" style="padding:10px;">
				<table class="walletTable" style="width:100%">
					<thead>
						<tr>
							<th>Money Kind</th>
							<th>GTXp Point</th>
						</tr>
					</thead>
					<tr>
						<td>Total</td>
						<td><span id="tot_GTXp">0</span> GTXp</td>
					</tr>
				</table>
			</div>
		</div>
		<div class="section">
			<div class="innerBox" style="padding:10px;">
			<form name="reg_frm" id="reg_frm" method="post">
			<input type="hidden" name="userid"		value="<%=session("userid")%>" />
			<input type="hidden" name="cyber_kind"	value="6202">
			<input type="hidden" name="work_user"	value="<%=session("userid")%>" />
				<table class="transfterTable">
					<colgroup>
						<col style="width:100px;">
						<col style="auto;">
					</colgroup>
					<tr>
						<th>Point<br />method</th>
						<td>
							<label>
								<input	type="radio" name="point_method"
										check="T" check_type="check" check_length="0" check_key=""
										title="Please check Point method, which you want to."
										value="GTXp" /> GTXp
							</label>
						</td>
					</tr>
					<tr>
						<th>E-Wallet balance</th>
						<td>
							<input	type="text" id="cur_amt"
									readOnly onFocus="this.blur();" />
						</td>
					</tr>
					<tr>
						<th>Available<br>amounts</th>
						<td>
							<input	type="text" name="avail_amt" id="avail_amt"
									readOnly onFocus="this.blur();" />
						</td>
					</tr>
					<tr>
						<th>Methods</th>
						<td>
							<label>
								<input	type="radio" name="request_method" id="request_method"
										check="T" check_type="check" check_length="0" check_key=""
										title="Please check Coin method, which you want to."
										value="bank"
										onClick="set_field(this.value);"> Bank
							</label>
						</td>
					</tr>
					<tr>
						<th>Request<br>amount</th>
						<td>
							<input	type="number" name="req_amt" id="req_amt"
									check="T" check_type="length" check_length="0" check_key=""
									title="Please input request amounts."
									onChange="return cal_amt();" /> GTXp
						</td>
					</tr>
					<tr>
						<th>Fee (5%)</th>
						<td>
							<input	type="text" name="fee_amt" id="fee_amt"
									check="T" check_type="length" check_length="0" check_key=""
									title="Amounts calculation is not valid."
									readOnly onFocus="$('#req_amt').focus();" /> GTXp
						</td>
					</tr>
					<!--------------------- Bank Request ----------------->
					<%
					sql =		"select bank_name, bank_nation, username as bank_owner, bank_account	"
					sql = sql & "  from dist where userid = '" & Session("userid") & "'					"
					Set bk_rs = DBConn.Execute(sql)
					If bk_rs.EOF Then
						bank_name	= ""
						bank_nation = ""
						bank_owner	= ""
						bank_account= ""
					Else
						bank_name	= bk_rs("bank_name")
						bank_nation = bk_rs("bank_nation")
						bank_owner	= bk_rs("bank_owner")
						bank_account= bk_rs("bank_account")
					End If
					%>
					<tr class="bank_fld" style="display:none;">
						<th style="vertical-align:middle;">Country</th>
						<td>
							<input	type="text" name="bank_nation" id="bank_nation"
									check="T" check_type="length" check_length="2" check_key=""
									title="Please input the bank nation."
									value="<%=bank_nation%>" readonly />
						</td>
					</tr>

					<tr class="bank_fld" style="display:none;">
						<th style="vertical-align:middle;">Name of bank</th>
						<td>
							<input	type="text" name="bank_name" id="bank_name"
									check="T" check_type="length" check_length="0" check_key=""
									title="Please input the bank name."
									value="<%=bank_name%>" readonly />
						</td>
					</tr>

					<tr class="bank_fld" style="display:none;">
						<th style="vertical-align:middle;">Account number</th>
						<td>
							<input	type="text" name="bank_acc" id="bank_acc"
									check="T" check_type="length" check_length="9" check_key=""
									title="Please input the bank account."
									value="<%=bank_account%>" readonly />
						</td>
					</tr>

					<tr class="bank_fld" style="display:none;">
						<th style="vertical-align:middle;">Holder name</th>
						<td>
							<input	type="text" name="bank_owner" id="bank_owner"
									check="T" check_type="length" check_length="2" check_key=""
									title="Please input the bank owner."
									value="<%=bank_owner%>" readonly />
						</td>
					</tr>

					<tr class="bank_fld" style="display:none;">
						<th style="vertical-align:middle;">USD($)</th>
						<td>
							<input	type="text" name="bank_amt" id="bank_amt"
									check="T" check_type="length" check_length="2" check_key=""
									title="Please input the USD($) amounts."
									value="" readonly />
						</td>
					</tr>
					<tr>
						<th>Total request</th>
						<td>
							<input	type="text" name="trans_amt" id="trans_amt"
									check="T" check_type="length" check_length="0" check_key=""
									title="Amounts calculation is not valid."
									readOnly onFocus="$('#req_amt').focus();" />
						</td>
					</tr>
					<!--
					<tr>
						<th>FIN#</th>
						<td>
							<input type="text">
						</td>
					</tr>
					-->
				</table>
			</div>
		</div>
		<div class="section">
			<div class="innerBox btnWrap">
				<button type="button" class="btnDefault" id="btnSend" style="background:#8666b2;">Request</button>
			</div>
		</div>
	</div>
</div>

<!-- #include virtual = "/myoffice/inc/footer.html" -->
<script>
$("#btnSend").on("click", function(){
	var proc_ok = "T";
	if (!$("#reg_frm").validation()){
		proc_ok = "F";
		return false;
	}

	if (proc_ok == "T")	{
		ajaxSendRequest();
	}
});

function ajaxSendRequest(){
	var url = "/myoffice/json_data/wallet_request_proc.html";
	var data = $("#reg_frm").serializeObject();

	$.ajax({
		url : url,
		global :false,
		contentType : "application/x-www-form-urlencoded; charset=utf-8",
		type : "POST",
		data : data,
		dataType: 'json',
		crossDomain: true,
		async:false,
		success:function(rtnData){
			console.log(rtnData);
			var rtnState= rtnData.rtn_state;
			var rtnMsg 	= (rtnData.rtn_msg) ? rtnData.rtn_msg.replace(/\\n/g, '\n') : rtnData.rtn_msg;
			var	rtnUrl 	= rtnData.rtn_url;

			if (rtnState == "SUCCESS") {
				alert(rtnMsg);
				location.href = rtnUrl;
			} else {
				alert(rtnMsg);
			}
		},
		error:function(reponse,textStatus,errorThrown){
			alert("Sorry, a temporary error occurred. Please reopen, thank you.");
		},
		beforeSend:function(){
		}
	});
}

$("input:radio[name=point_method]").on("click", function(){
	var tmp_val = $(this).val();
	var tot_coin = $("#tot_" + tmp_val).text();

	$("#cur_amt"	).val(tot_coin);
	$("#avail_amt"	).val(tot_coin);

	if (tmp_val == "coinp"){
		$("input:radio[name=request_method][value=bank]").prop("disabled", true);
		$("input:radio[name=request_method][value=coin]").trigger("click");
	}else{
		$("input:radio[name=request_method][value=bank]").prop("disabled", false);
		$("input:radio[name=request_method][value=coin]").trigger("click");
	}
});
</script>