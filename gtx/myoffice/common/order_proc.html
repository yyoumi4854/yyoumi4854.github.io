<%@ CodePage="65001" Language="vbscript"%>
<!-- #include virtual="/myoffice/common/common.inc"-->
<!-- #include virtual="/myoffice/common/adovbs.inc" -->
<%
'On Error Resume Next
'printRequest()
'Response.End

'--------------------------------------------------------------------------------------------------------------
' 중복 검사를 위한 폼체크 S
'--------------------------------------------------------------------------------------------------------------
form_check = ""
For Each Key In Request.Form
	form_check = form_check & CStr(Key) & "=" & Request.Form(Key) & "|"
Next

query_check = ""
For Each Key In Request.QueryString
	query_check = query_check & CStr(Key) & "=" & Request.QueryString(Key)(Key) & "|"
Next

form_check = Replace(Replace(form_check,"'",""),"""","")
query_check= Replace(Replace(query_check,"'",""),"""","")


sql =		"select	*											"
sql = sql & "  from	LOG_FORM_CHECK								"
sql = sql & " where	form_value	= '" & form_check & "'			"
sql = sql & "   and	page		= 'order_proc.html'				"
sql = sql & "   and	CEIL((sysdate - work_date)*(24*60)) < 60	"
Set rs_check = DBConn.Execute(sql)

If Not rs_check.Eof Then
	res_state = "FAIL"
	res_msg	  = "You have entered same order information within 5 minutes period.\nPlease check your order history and try it again."
Else
	'--------------------------------------------------------------------------------------------------------------
	' 중복 검사를 위한 폼체크 S
	'--------------------------------------------------------------------------------------------------------------
	sql = "select log_seq.NextVal from dual"
	Set rs_seq = DBConn.Execute(sql)
		form_seq = rs_seq(0)
	rs_seq.Close

	sql =		"insert into LOG_FORM_CHECK (		"
	sql = sql & "	idx, page, form_value			"
	sql = sql & ") values (							"
	sql = sql & ""	&	"LOG_SEQ.NextVal"	& ",	"
	sql = sql & "'"	&	"order_proc.html"	& "',	"
	sql = sql & "'"	&	form_check			& "'	"
	sql = sql & ")									"
	DBConn.Execute(sql)
	'--------------------------------------------------------------------------------------------------------------
	' 중복 검사를 위한 폼체크 E
	'--------------------------------------------------------------------------------------------------------------
End If

order_from		= Trim(Request.Form("order_from"))

userid			= Trim(Request.Form("userid"))		: If userid = "" Then userid = Session("userid")
username		= Trim(Request.Form("user_name"))
center_cd		= Trim(Request.Form("center_cd"))

u_mobile		= Trim(Request.Form("user_mobile"))
u_mobile		= Replace(u_mobile, "-", "")

u_email			= Trim(Request.Form("user_email")) : If u_email = "@"	Then u_email = " @ "

prod_name		= Trim(Request.Form("prod_name"))

product			= Trim(Request.Form("product_cd"))	: product	= Replace(product," ","")
qty				= Trim(Request.Form("qty"))			: qty		= Replace(qty," ","")
deli_amt		= Trim(Request.Form("deli_amt"))	: If deli_amt = "" Then deli_amt = "0"
	If Len(deli_amt) < 3 Then
		deli_amt = 0
	Else
		deli_amt = CCur(deli_amt)
	End If

tot_amt			= Trim(Request.Form("tot_amt"))
usd_amt			= tot_amt
tot_pv1			= Trim(Request.Form("tot_pv1"))

d_firstname		= Trim(Request.Form("d_firstname"))
d_lastname		= Trim(Request.Form("d_lastname"))
d_name			= d_lastname & "," & d_firstname
d_email			= Trim(Request.Form("d_email"))

d_zipcode		= Trim(Request.Form("d_zipcode"))
d_addr1			= Trim(Request.Form("d_addr1"))
d_addr2			= Trim(Request.Form("d_addr2"))

d_mobile		= Trim(Request.Form("d_mobile"))

d_country		= Trim(Request.Form("d_country"))
point_amt		= Trim(Request.Form("point_amt"))
pay_amt			= tot_amt

delivery_com	= Trim(Request.Form("delivery_com"))	'// 배송시 요청사항
remarks			= delivery_com
work_user		= "WEB"

pay_kind		= Trim(Request.Form("pay_kind"))
Order_Kind		= Trim(Request.Form("order_kind"))

ab_cd			= Trim(Request.Form("ab_cd"))




If res_state = "FAIL" Then
	res_state   = "FAIL"
	res_msg		= "You have entered same order information within 5 minutes period.\nPlease check your order history and try it again."
Else
	'--------------------------------------------------------- 주문 등록 Procedure 호출

	path_kind	= "4403"		'// 인터넷 주문
	'order_kind  = "4101"		'// 일반주문
	r_kind		= "4202"		'// 택배
	work_note	= ""			'// 작업자 메모
	note_kind	= ""			'// 작업자

	sql =		"select	center_cd, to_char(sysdate,'yyyy-mm-dd') as order_date,							"
	sql = sql & "		case when to_char(SYSDATE , 'HH24') < '20' then TO_CHAR(SYSDATE,'YYYY-MM-DD')	"
	sql = sql & "			 else TO_CHAR(SYSDATE+1,'YYYY-MM-DD')										"
	sql = sql & "		 end as pay_date																"
	sql = sql & "  from	dist																			"
	sql = sql & " where	userid = '" & userid & "'														"
	Set rs_user = DBConn.Execute(sql)
		center_cd	= rs_user("center_cd")
		order_date	= rs_user("order_date")
		pay_date	= order_date		'rs_user("pay_date")
	rs_user.Close

	Set objCom  = Server.CreateObject("ADODB.Command")
	With objCom
		.ActiveConnection = DBConn
		.CommandType = 4
		.CommandText = "PROC_ORDER"

		.Parameters.Append .CreateParameter("sp_userid",		adVarChar, adParamInput,   20,	userid)
		.Parameters.Append .CreateParameter("sp_username",		adVarChar, adParamInput,  100,	username)
		.Parameters.Append .CreateParameter("sp_center_cd",		adVarChar, adParamInput,   10,	center_cd)
		.Parameters.Append .CreateParameter("sp_order_date",	adVarChar, adParamInput,   20,	order_date)
		.Parameters.Append .CreateParameter("sp_pay_date",		adVarChar, adParamInput,   20,	pay_date)
		.Parameters.Append .CreateParameter("sp_product",		adVarChar, adParamInput, 1000,	product)
		.Parameters.Append .CreateParameter("sp_qty",			adVarChar, adParamInput, 1000,	qty)
		.Parameters.Append .CreateParameter("sp_deli_amt",		adNumeric, adParamInput,    0,	deli_amt)
		.Parameters.Append .CreateParameter("sp_tot_amt",		adNumeric, adParamInput,    0,	pay_amt)
		.Parameters.Append .CreateParameter("sp_usd_amt",		adNumeric, adParamInput,    0,	usd_amt)
		.Parameters.Append .CreateParameter("sp_path_kind",		adVarChar, adParamInput,   10,	path_kind)
		.Parameters.Append .CreateParameter("sp_order_kind",	adVarChar, adParamInput,   10,	order_kind)
		.Parameters.Append .CreateParameter("sp_r_kind",		adVarChar, adParamInput,   10,	r_kind)
		.Parameters.Append .CreateParameter("sp_d_name",		adVarChar, adParamInput,  100,	d_name)
		.Parameters.Append .CreateParameter("sp_tel	",			adVarChar, adParamInput,   30,	d_tel)
		.Parameters.Append .CreateParameter("sp_mobile",		adVarChar, adParamInput,   30,	d_mobile)
		.Parameters.Append .CreateParameter("sp_email",			adVarChar, adParamInput,  150,	d_email)
		.Parameters.Append .CreateParameter("sp_zipcode",		adVarChar, adParamInput,   10,	d_zipcode)
		.Parameters.Append .CreateParameter("sp_address1",		adVarChar, adParamInput,  255,	d_addr1)
		.Parameters.Append .CreateParameter("sp_address2",		adVarChar, adParamInput,  255,	d_addr2)
		.Parameters.Append .CreateParameter("sp_country",		adVarChar, adParamInput,   10,	d_country)
		.Parameters.Append .CreateParameter("sp_autoship_idx",	adVarChar, adParamInput,   20,	"0")
		.Parameters.Append .CreateParameter("sp_remarks",		adVarChar, adParamInput, 4000,	remarks)
		.Parameters.Append .CreateParameter("sp_note_kind",		adVarChar, adParamInput,   20,	note_kind)
		.Parameters.Append .CreateParameter("sp_injeong",		adVarChar, adParamInput,   20,	"0")
		.Parameters.Append .CreateParameter("sp_work_note",		adVarChar, adParamInput, 4000,	work_note)
		.Parameters.Append .CreateParameter("sp_work_user",		adVarChar, adParamInput,   30,	work_user)
		.Parameters.Append .CreateParameter("sp_result",		adVarChar, adParamOutput,  10)
		.Parameters.Append .CreateParameter("sp_error",			adVarChar, adParamOutput, 255)
		.Parameters.Append .CreateParameter("sp_order_no",		adVarChar, adParamOutput,  20)
		.Execute  , , adExecuteNoRecords
	End With
		sp_result	= objCom.Parameters("sp_result").VALUE
		sp_error	= objCom.Parameters("sp_error").VALUE
		sp_order_no	= objCom.Parameters("sp_order_no").VALUE
	Set objCom = Nothing

	If sp_result = "SUCCESS" Then


		If CCur(pay_amt) > 0 Then
			If CCur(pay_amt) > 0 Then
				pay_tran	= coin_pay(sp_order_no, pay_kind, pay_amt, depositor, ab_cd, work_user)
				pay_result = Split(pay_tran,":")(0)
				pay_msg	= Split(pay_tran,":")(1)

				ret_result	= ret_result & pay_kind &": "	& pay_msg
			Else
				pay_result = "FAIL"
			End If
		End If

		If order_kind = "4103" Then
			sql = "select  b.userid, b.user_kind, b.rank_cd, b.rank_name	"
			sql = sql & "  from  vorder_head a, dist b						"
			sql = sql & " where  a.userid = b.userid						"
			sql = sql & "   and  a.order_kind = '4103'						"
			sql = sql & "   and  a.ischeck = '1'							"
			sql = sql & "   and  a.order_type <> '4'						"
			sql = sql & "   and  a.bank_date is not null					"
			sql = sql & "   and  a.order_no = '" & sp_order_no & "'			"
			sql = sql & "   and  a.userid = '" & userid & "'				"
			Set rs_up = DBConn.Execute(sql)
			If Not rs_up.EOF Then
				n_user_kind 	= CStr(rs_up("user_kind"))
				n_rank_cd 		= CStr(rs_up("rank_cd"))
				n_max_rank_cd 	= CStr(rs_up("max_rank_cd"))
				If n_user_kind = "2101" Then
					If n_rank_cd = "1" Then
						sql = 		"update dist set 					"
						sql = sql & "		user_kind = '2102', 		"
						sql = sql & "		rank_cd = '2', 				"
						sql = sql & "		rank_name = 'Reseller', 	"
						sql = sql & "		max_rank_cd = '2', 			"
						sql = sql & "		max_rank_name = 'Reseller'	"
						sql = sql & "		max_rank_date = to_char(sysdate, 'yyyy-mm-dd')	"
						sql = sql & " where userid = '" & userid & "' 	"
						DBConn.Execute(sql)
						Session("user_kind") = "2102"
					End If
				ElseIf n_user_kind = "2102" Then
					If n_rank_cd = "2" Then
						sql = 		"update dist set 					"
						sql = sql & "		user_kind = '2103' 			"
						sql = sql & " where userid = '" & userid & "' 	"
						DBConn.Execute(sql)
						Session("user_kind") = "2103"
					End If
				End If
			End If
			rs_up.Close : Set rs_up = Nothing
		End If

		If pay_result = "SUCCESS" Then
			'// 결재 성공 이동
			res_state = "SUCCESS"
			res_msg		= "Your order request has been successfully processed."
		Else
			res_state = "FAIL"
			res_msg		= "Failed to process your order request, Please try it again later.\nReason : " & pay_msg
		End If

	Else
		res_state = "FAIL"
		res_msg		= "There was an error occur during the order process.\nIf it continues to happen, Please contact the CS center.\nReason : " & sp_error
	End If

End If

'// 결과 표시
Response.Write res_state & "|" & res_msg & "|" & sp_order_no
'///////////////////

Function coin_pay(fORDER_NO, fPAYKIND, fAMT, fDEPOSITOR, fDEPO_BANK, fWORKUSER)

	'On Error Resume Next
	fPAYSTATE = "W"
	If fPAYKIND = "BANK" Then
		sql =		"select *								"
		sql = sql & "  from	admit_bank						"
		sql = sql & " where ab_cd = '" & fDEPO_BANK & "'	"
		Set rs_bank = DBConn.Execute(sql)
			ab_name		= rs_bank("ab_name")
			ab_account	= rs_bank("ab_account")
		rs_bank.Close
	ElseIf fPAYKIND = "POINT" Then
		fPAYSTATE = "C"
		ab_name		= ""
		ab_account	= ""
	End If

	set objCom  = Server.CreateObject("ADODB.Command")
	With objCom
		.ActiveConnection = DBConn
		.CommandType = 4
		.CommandText = "PROC_ORDER_PAY"

		.Parameters.Append .CreateParameter("SP_ORDER_NO",		adVarChar, adParamInput, 20,	fORDER_NO)
		.Parameters.Append .CreateParameter("SP_PAY_KIND",		adVarChar, adParamInput, 10,	fPAYKIND)
		.Parameters.Append .CreateParameter("SP_PAY_STATE",		adVarChar, adParamInput, 10,	fPAYSTATE)
		.Parameters.Append .CreateParameter("SP_PAY_AMT",		adNumeric, adParamInput,  0,	fAMT)
		.Parameters.Append .CreateParameter("SP_CARD_OID",		adVarChar, adParamInput, 20,	"-")
		.Parameters.Append .CreateParameter("SP_CARD_MID",		adVarChar, adParamInput, 20,	"")
		.Parameters.Append .CreateParameter("SP_CARD_RESCODE",	adVarChar, adParamInput, 20,	"")
		.Parameters.Append .CreateParameter("SP_CARD_RESMSG",	adVarChar, adParamInput,255,	"")
		.Parameters.Append .CreateParameter("SP_CARD_TRANNO",	adVarChar, adParamInput, 30,	"")
		.Parameters.Append .CreateParameter("SP_CARD_CD",		adVarChar, adParamInput, 20,	"")
		.Parameters.Append .CreateParameter("SP_CARD_NAME",		adVarChar, adParamInput, 30,	"")
		.Parameters.Append .CreateParameter("SP_CARD_NO",		adVarChar, adParamInput,100,	"")
		.Parameters.Append .CreateParameter("SP_EXP_DATE",		adVarChar, adParamInput, 20,	"")
		.Parameters.Append .CreateParameter("SP_CARD_INST",		adVarChar, adParamInput, 20,	"")
		.Parameters.Append .CreateParameter("SP_APPROV_NO",		adVarChar, adParamInput, 50,	"")
		.Parameters.Append .CreateParameter("SP_APPROV_DATE",	adVarChar, adParamInput, 30,	"")
		.Parameters.Append .CreateParameter("SP_BANK_CD",		adVarChar, adParamInput, 10,	"")
		.Parameters.Append .CreateParameter("SP_BANK_NAME",		adVarChar, adParamInput, 50,	ab_name)
		.Parameters.Append .CreateParameter("SP_BANK_ACC",		adVarChar, adParamInput,255,	ab_account)
		.Parameters.Append .CreateParameter("SP_BANK_TRANNO",	adVarChar, adParamInput, 30,	"")
		.Parameters.Append .CreateParameter("SP_BANK_FLAG",		adVarChar, adParamInput, 10,	"")
		.Parameters.Append .CreateParameter("SP_SETTLE_DATE",	adVarChar, adParamInput, 10,	"")
		.Parameters.Append .CreateParameter("SP_CASH_AUTH_KIND",adVarChar, adParamInput, 20,	"")
		.Parameters.Append .CreateParameter("SP_CASH_AUTH_NO",	adVarChar, adParamInput, 20,	"")
		.Parameters.Append .CreateParameter("SP_RECEIPT",		adVarChar, adParamInput, 30,	fDEPOSITOR)
		.Parameters.Append .CreateParameter("SP_CUR_RATE",		adNumeric, adParamInput,  0,	1)
		.Parameters.Append .CreateParameter("SP_USD_AMT",		adNumeric, adParamInput,  0,	fAMT)
		.Parameters.Append .CreateParameter("SP_WORK_USER",		adVarChar, adParamInput, 30,	fWORKUSER)
		.Parameters.Append .CreateParameter("SP_RESULT",		adVarChar, adParamOutput, 20)
		.Parameters.Append .CreateParameter("SP_ERROR",			adVarChar, adParamOutput, 255)
		.Parameters.Append .CreateParameter("SP_ORDER_SEQ",		adVarChar, adParamOutput, 20)
		.Execute  , , adExecuteNoRecords
	End With
		PAY_RESULT	= objCom.Parameters("SP_RESULT").VALUE
		PAY_ERROR	= objCom.Parameters("SP_ERROR").VALUE
		ORDER_SEQ	= objCom.Parameters("SP_ORDER_SEQ").VALUE
	Set objCom = nothing

	If pay_result = "SUCCESS" Then
		coin_pay = PAY_RESULT & ":" & "Success"
	Else
		coin_pay = PAY_RESULT & ":" & "Fail"
	End If

End Function

Function Add_Space(no)
	temp_str = ""
	FOR I=1 To no
		temp_str = temp_str & CHR(32)
	Next
	Add_Space = temp_str
End Function

function STRLen(str)
     STRLen = 0
     for ii = 1 to len(str)
           if asc(mid(str, ii, 1)) < 0 then
                 STRLen = STRLen + 2
           else
                 STRLen = STRLen + 1
           end if
     next
end function

function STRLeft(str, num)
     num2 = 0
     for ii = 1 to len(str)
           if asc(mid(str, ii, 1)) < 0 then
                 STRLeft = STRLeft & mid(str, ii, 1)
                 num2 = num2 + 2
           else
                 STRLeft = STRLeft & mid(str, ii, 1)
                 num2 = num2 + 1
           end if
           if num2 >= num then exit for
     next
end function

FUNCTION GetLength(strText)
	IF IsNULL(strText) Then
		GetLength = 0
		Exit Function
	END IF

	nByteLen	= 0
	nTextLength = Len(strText)
	nIdx		= 1

	For nLenIdx = 1 to nTextLength
		IF ASC(Mid(strText, nIdx, 1)) < 0 THEN
			nByteLen = nByteLen + 2
		ELSE
			nByteLen = nByteLen + 1
		END IF

		nIdx = nIdx + 1
	Next

	GetLength = nByteLen
END FUNCTION

Function SetLength(strText, cutCount)
	nIdx = 1

	IF GetLength(strText) > cutCount THEN
		FOR nLenIdx = 0 TO cutCount
			IF ASC(MID(strText, nIdx, 1)) <= 0 THEN
				IF nLenIdx = cutCount - 1 THEN
					Exit FOR
				END IF
				nLenIdx = nLenIdx + 1
			END IF
			strResult = strResult & MID(strText, nIdx, 1)
			nIdx = nIdx + 1
		NEXT
	ELSE
		strResult = strText
	END IF
	SetLength = strResult
END Function

Function GetXmlHttp(XmlURL, xmlString)
    Set xmlHttp = Server.CreateObject("MSXML2.ServerXMLHTTP")
		xmlHttp.setOption(3) = ""
		xmlHttp.setRequestHeader "Content-Type", "application/x-www-form-urlencoded"
		xmlHttp.Open "GET", XmlURL, False
		xmlHttp.Send
		GetXmlHttp = xmlHttp.responseText
	Set xmlHttp = Nothing
End Function


Function PostXmlHttp(fSENDURL, fSENDSTR)

	On Error Resume Next

	Set xmlHttp = Server.CreateObject("MSXML2.ServerXMLHTTP")
'		xmlHttp.setOption(3) = ""
		xmlHttp.Open "POST", fSENDURL, False
		xmlHttp.setRequestHeader "Content-Type", "application/x-www-form-urlencoded"
		xmlHttp.Send fSENDSTR

'		Response.Write "<textarea cols=50 rows=10>" & xmlHttp.responseText & "</textarea>"
'		Response.Flush

		PostXmlHttp = xmlHttp.responseText
	Set xmlHttp = Nothing

End Function
%>
<!--#include virtual="/myoffice/common/db_close.inc"-->
